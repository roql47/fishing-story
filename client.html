<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>üé£ Ïó¨Ïö∞Ïù¥ÏïºÍ∏∞ V1.0</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      display: flex;
      flex-direction: row;
      gap: 25px;
    }
    .chat-container {
      flex: 1;
    }
    .user-list-container {
      width: 200px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      height: fit-content;
      margin-bottom: 15px;
    }
    .user-list-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #4a90e2;
      text-align: center;
    }
    .user-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .user-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-item:hover {
      background-color: #f5f5f5;
    }
    h1 {
      color: #4a90e2;
      text-align: center;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #messages {
      height: 300px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      white-space: pre-line;
    }
    #messageForm {
      display: flex;
      gap: 5px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #357ab7;
    }
    #controls {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #controls label {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #controls input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .userNickname {
      color: #4a90e2;
      cursor: pointer;
      text-decoration: underline;
    }
    /* ÏÉÅÏ†ê Ïä§ÌÉÄÏùº */
    .shop-container {
      margin-top: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
    }
    .shop-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #4a90e2;
      text-align: center;
    }
    .shop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .shop-item:last-child {
      border-bottom: none;
    }
    .shop-item-info {
      flex: 1;
    }
    .shop-item-name {
      font-weight: bold;
    }
    .shop-item-price {
      color: #4a90e2;
    }
    .shop-item-desc {
      font-size: 0.9em;
      color: #666;
    }
    /* ÏÉÅÏ†ê Ïπ¥ÌÖåÍ≥†Î¶¨ Ïä§ÌÉÄÏùº */
    .shop-categories {
      margin-bottom: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
    }
    .shop-category {
      padding: 8px 12px;
      cursor: pointer;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
      font-size: 0.9em;
    }
    .shop-category.active {
      background: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
      font-weight: bold;
    }
    .buy-button {
      padding: 6px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .buy-button:hover {
      background-color: #45a049;
    }
    #shop-items-container {
      max-height: 400px;
      overflow-y: auto;
    }
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      background: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* Î°úÍ∑∏Ïù∏ Î∞è ÌöåÏõêÍ∞ÄÏûÖ Ìèº Ïä§ÌÉÄÏùº */
    .auth-container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .auth-form input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .auth-form button {
      margin-top: 10px;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }
    .auth-toggle a {
      color: #4a90e2;
      text-decoration: none;
      cursor: pointer;
    }
    .auth-toggle a:hover {
      text-decoration: underline;
    }
    .auth-message {
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }
    .auth-message.error {
      background: #ffebee;
      color: #d32f2f;
      display: block;
    }
    .auth-message.success {
      background: #e8f5e9;
      color: #388e3c;
      display: block;
    }
    .user-info {
      background: #f1f8e9;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .user-info-text {
      font-weight: bold;
    }
    #logoutBtn {
      padding: 5px 10px;
      font-size: 12px;
    }
    #authContainer {
      display: block;
    }
    #chatContainer {
      display: none;
    }
    /* Î™®Îã¨ Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-modal:hover {
      color: #555;
    }
    .inventory-list {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .inventory-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .modal-title {
      color: #4a90e2;
      margin-top: 0;
      font-size: 1.2em;
    }
    /* Fish Ïù¥Î™®Ìã∞ÏΩò Ï∂îÍ∞Ä */
    .fish-emoji {
      margin-right: 5px;
    }
    
    .gold-amount {
      color: #f8c537;
      font-weight: bold;
    }
    /* Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÎìúÎ°≠Îã§Ïö¥ Ïä§ÌÉÄÏùº */
    .fish-info-dropdown {
      position: relative;
      display: inline-block;
      margin-left: 10px;
    }
    
    .fish-info-btn {
      background: linear-gradient(to bottom, #3498db, #2980b9);
      color: white;
      border: none;
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 0.85em;
      transition: all 0.3s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .fish-info-btn:hover {
      background: linear-gradient(to bottom, #2980b9, #2471a3);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .fish-info-content {
      display: none;
      position: absolute;
      background-color: #fff;
      min-width: 340px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
      z-index: 1000;
      border-radius: 12px;
      padding: 20px;
      right: 0;
      max-height: 500px;
      overflow-y: auto;
      transition: all 0.3s ease;
      border: 1px solid #e0e0e0;
    }
    
    .fish-info-content.show {
      display: block;
      animation: fadeIn 0.3s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* ÏÑ∏Î†®Îêú Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ Ïä§ÌÉÄÏùº */
    .fish-info-title {
      font-size: 1.1em;
      font-weight: bold;
      color: #3498db;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0f0f0;
      text-align: center;
    }
    
    .fish-card {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 10px;
      background: #fafafa;
      transition: all 0.2s;
      border-left: 4px solid #3498db;
    }
    
    .fish-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      background: #f5f5f5;
    }
    
    .fish-icon {
      margin-right: 12px;
      font-size: 1.6em;
      color: #555;
    }
    
    .fish-details {
      flex: 1;
    }
    
    .fish-name {
      font-weight: bold;
      color: #333;
      margin: 0;
      font-size: 1em;
    }
    
    .fish-stats {
      display: flex;
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
      flex-wrap: wrap;
    }
    
    .fish-probability {
      margin-right: 15px;
      display: flex;
      align-items: center;
    }
    
    .probability-bar {
      display: inline-block;
      width: 40px;
      height: 6px;
      background: #e0e0e0;
      border-radius: 3px;
      margin-left: 5px;
      overflow: hidden;
    }
    
    .probability-fill {
      height: 100%;
      background: linear-gradient(to right, #2ecc71, #27ae60);
      border-radius: 3px;
    }
    
    .fish-price {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .rare-fish {
      background: #fff8e1;
      border-left: 4px solid #ffc107;
    }
    
    .rare-fish .fish-icon {
      color: #ff9800;
    }
    
    .skill-info {
      background: linear-gradient(to right, #e3f2fd, #bbdefb);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    
    .skill-level {
      font-weight: bold;
      font-size: 1.1em;
      color: #2196f3;
    }
    
    .skill-tip {
      font-size: 0.9em;
      color: #555;
      font-style: italic;
    }
    
    .fish-category {
      color: #3498db;
      font-size: 0.95em;
      font-weight: bold;
      margin: 15px 0 10px 0;
      padding-bottom: 5px;
      border-bottom: 1px solid #eee;
    }
    
    /* ÏÇ¨Ïù¥Îìú Ïª®ÌÖåÏù¥ÎÑà Ïä§ÌÉÄÏùº */
    .side-container {
      width: 220px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-left: 15px;
    }
    
    /* ÎÇöÏãú Ï†ïÎ≥¥ ÏúÑÏ†Ø Ïä§ÌÉÄÏùº */
    .fishing-info-widget {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .fishing-info-header {
      background: linear-gradient(135deg, #3498db, #2c3e50);
      color: white;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }
    
    .fishing-info-title {
      font-weight: bold;
      font-size: 1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .fishing-info-toggle {
      transition: transform 0.3s ease;
    }
    
    .fishing-info-widget.collapsed .fishing-info-toggle {
      transform: rotate(-90deg);
    }
    
    .fishing-info-content {
      padding: 18px;
      max-height: 500px;
      overflow-y: auto;
      transition: max-height 0.3s ease;
    }
    
    .fishing-info-widget.collapsed .fishing-info-content {
      max-height: 0;
      padding: 0 15px;
      overflow: hidden;
    }
    
    /* Î¨ºÍ≥†Í∏∞ Ïπ¥Îìú Ïû¨Ï†ïÏùò */
    .fish-card {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 10px;
      border-radius: 8px;
      background: #f8f9fa;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: all 0.2s;
      border-left: 3px solid #3498db;
    }
    
    .fish-card:last-child {
      margin-bottom: 0;
    }
    
    .fish-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .fish-icon {
      flex-shrink: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 10px;
      font-size: 1.3em;
    }
    
    .fish-details {
      flex: 1;
      min-width: 0;
    }
    
    .fish-name {
      font-weight: 600;
      color: #333;
      margin: 0;
      font-size: 0.9em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .fish-stats {
      display: flex;
      font-size: 0.75em;
      color: #666;
      margin-top: 3px;
      flex-wrap: wrap;
    }
    
    .fish-probability {
      margin-right: 12px;
      display: flex;
      align-items: center;
    }
    
    .probability-bar {
      display: inline-block;
      width: 36px;
      height: 4px;
      background: #eee;
      border-radius: 2px;
      margin-left: 4px;
      overflow: hidden;
    }
    
    .probability-fill {
      height: 100%;
      background: linear-gradient(to right, #2ecc71, #27ae60);
      border-radius: 2px;
    }
    
    .fish-price {
      color: #e74c3c;
      font-weight: 600;
    }
    
    .skill-info {
      background: linear-gradient(to right, #e3f2fd, #bbdefb);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .skill-level {
      font-weight: 600;
      font-size: 0.9em;
      color: #1976d2;
    }
    
    .skill-tip {
      font-size: 0.75em;
      color: #555;
      font-style: italic;
    }
    
    .fish-category {
      color: #3498db;
      font-size: 0.85em;
      font-weight: 600;
      margin: 12px 0 8px 0;
      padding-bottom: 4px;
      border-bottom: 1px solid #eee;
    }
    
    .fish-info-title {
      font-size: 1em;
      font-weight: 600;
      color: #3498db;
      margin-bottom: 10px;
      text-align: center;
    }
    
    .rare-fish {
      border-left-color: #ff9800;
      background: #fff8e1;
    }
    
    .rare-fish .fish-icon {
      color: #ff9800;
    }
    
    .rare-fish .fish-icon {
      color: #ff9800;
    }
    
    /* ÎèôÎ£åÎ™®Ïßë Ïä§ÌÉÄÏùº */
    .recruit-container {
      padding: 15px;
      background: #fff;
      border-radius: 8px;
    }
    
    .recruit-description {
      margin-bottom: 20px;
      text-align: center;
      color: #555;
      line-height: 1.5;
    }
    
    .companion-name {
      font-weight: bold;
      color: #673AB7;
    }
    
    .companions-container {
      display: flex;
      justify-content: space-around;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    
    .companion-card {
      width: 180px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .companion-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }
    
    .companion-image {
      height: 120px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .companion-emoji {
      font-size: 4em;
    }
    
    .companion-info {
      padding: 15px;
      text-align: center;
    }
    
    .companion-info h3 {
      margin: 0 0 8px;
      color: #673AB7;
    }
    
    .companion-info p {
      margin: 0;
      color: #666;
      font-size: 0.9em;
    }
    
    .recruit-controls {
      text-align: center;
      margin-top: 20px;
    }
    
    .recruit-button {
      background: linear-gradient(135deg, #9C27B0, #673AB7);
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
    }
    
    .recruit-button:hover {
      background: linear-gradient(135deg, #8E24AA, #5E35B1);
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    }
    
    .recruit-button:disabled {
      background: #9e9e9e;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .recruit-result {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      min-height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
    }
    
    .recruit-success {
      background-color: #E8F5E9;
      color: #2E7D32;
      border: 1px solid #A5D6A7;
    }
    
    .recruit-fail {
      background-color: #FFEBEE;
      color: #C62828;
      border: 1px solid #FFCDD2;
    }
    
    .recruit-animation {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .skill-info {
      background: linear-gradient(to right, #e3f2fd, #bbdefb);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    /* ÏúÑÏ†Ø Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ Í¥ÄÎ†® Ïä§ÌÉÄÏùº */
    .fishing-info-widget.collapsed .fishing-info-content {
      display: none;
    }
    
    .fishing-info-header {
      cursor: pointer;
    }
    
    .fishing-info-toggle {
      transition: transform 0.3s;
    }
    
    .fishing-info-widget.collapsed .fishing-info-toggle {
      transform: rotate(180deg);
    }
  </style>
</head>
<body>
  <!-- Ïù∏Ï¶ù Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="authContainer" class="auth-container">
    <h1>üé£ Ïó¨Ïö∞Ïù¥ÏïºÍ∏∞ <span style="font-size: 0.6em; color: #666;">V1.0</span></h1>
    
    <!-- Î°úÍ∑∏Ïù∏ Ìèº -->
    <div id="loginForm" class="auth-form">
      <h2>Î°úÍ∑∏Ïù∏</h2>
      <input type="text" id="loginUsername" placeholder="ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ" required>
      <input type="password" id="loginPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" required>
      <button id="loginBtn">Î°úÍ∑∏Ïù∏</button>
      <div id="loginMessage" class="auth-message"></div>
      <div class="auth-toggle">
        Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? <a id="showRegisterBtn">ÌöåÏõêÍ∞ÄÏûÖ</a>
      </div>
      <div class="auth-toggle">
        <a id="guestLoginBtn">Í≤åÏä§Ìä∏Î°ú ÏûÖÏû•ÌïòÍ∏∞</a>
      </div>
    </div>
    
    <!-- ÌöåÏõêÍ∞ÄÏûÖ Ìèº -->
    <div id="registerForm" class="auth-form" style="display: none;">
      <h2>ÌöåÏõêÍ∞ÄÏûÖ</h2>
      <input type="text" id="registerUsername" placeholder="ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ" required>
      <input type="password" id="registerPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" required>
      <input type="password" id="confirmPassword" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏" required>
      <button id="registerBtn">ÌöåÏõêÍ∞ÄÏûÖ</button>
      <div id="registerMessage" class="auth-message"></div>
      <div class="auth-toggle">
        Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî? <a id="showLoginBtn">Î°úÍ∑∏Ïù∏</a>
      </div>
    </div>
  </div>

  <!-- Ï±ÑÌåÖ Ïª®ÌÖåÏù¥ÎÑà -->
  <div id="chatContainer" style="width: 100%; display: flex;">
    <div class="chat-container">
      <h1>üé£ Ïó¨Ïö∞Ïù¥ÏïºÍ∏∞ <span style="font-size: 0.6em; color: #666;">V1.0</span></h1>
      
      <div id="userInfo" class="user-info">
        <span id="userInfoText" class="user-info-text">Í≤åÏä§Ìä∏Î°ú Î°úÍ∑∏Ïù∏Îê®</span>
        <button id="logoutBtn">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
      
      <div id="status">ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú: <span style="color:red;">Ïó∞Í≤∞ Ï§ë...</span></div>
      
      <div id="controls">
        <label>Î∞© Ïù¥Î¶Ñ: <input id="roomInput" value="Í∏∞Î≥∏Î∞©" /></label>
        <button id="joinButton">ÏûÖÏû•</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="chat">üí¨ Ï±ÑÌåÖ</div>
        <div class="tab" data-tab="shop">üõí ÏÉÅÏ†ê</div>
        <div class="tab" data-tab="recruit">üßô‚Äç‚ôÄÔ∏è ÎèôÎ£åÎ™®Ïßë</div>
      </div>

      <div id="chatTab" class="tab-content active">
        <div id="messages"></div>

        <form id="messageForm" style="display:none;">
          <input type="text" id="messageInput" placeholder="Î™ÖÎ†πÏñ¥ÎÇò Î©îÏãúÏßÄ ÏûÖÎ†•..." />
          <button type="submit">Ï†ÑÏÜ°</button>
        </form>
      </div>

      <div id="shopTab" class="tab-content">
        <div class="shop-container">
          <div class="shop-title">üõí ÎÇöÏãú Ïö©Ìíà ÏÉÅÏ†ê</div>
          <div class="tabs shop-categories">
            <div class="tab shop-category active" data-category="rods">üé£ ÎÇöÏãúÎåÄ</div>
            <div class="tab shop-category" data-category="accessories">üíç ÏïÖÏÑ∏ÏÇ¨Î¶¨</div>
            <div class="tab shop-category" data-category="items">üì¶ Í∏∞ÌÉÄ</div>
          </div>
          <div id="shop-items-container">
            <!-- ÏÉÅÏ†ê ÏïÑÏù¥ÌÖúÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
          </div>
        </div>
      </div>
      
      <div id="recruitTab" class="tab-content">
        <div class="shop-container">
          <div class="shop-title">üßô‚Äç‚ôÄÔ∏è ÎèôÎ£å Î™®ÏßëÏÜå</div>
          <div class="recruit-container">
            <div class="recruit-description">
              <p>Î≥ÑÏ°∞Í∞Å 1Í∞úÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÎèôÎ£åÎ•º Î™®ÏßëÌï† Ïàò ÏûàÏäµÎãàÎã§. (ÏÑ±Í≥µ ÌôïÎ•†: 15%)</p>
              <p>Î™®Ïßë Í∞ÄÎä•Ìïú ÎèôÎ£å: <span class="companion-name">Ïã§</span>, <span class="companion-name">ÌîºÏóêÎÇò</span>, <span class="companion-name">Ïï†ÎπÑÍ≤åÏùº</span></p>
            </div>
            <div class="companions-container">
              <div class="companion-card">
                <div class="companion-image" style="background-color: #FFCDD2;">
                  <span class="companion-emoji">üë©‚Äçü¶∞</span>
                </div>
                <div class="companion-info">
                  <h3>Ïã§</h3>
                  <p>ÎÇöÏãú ÌôïÎ•† +5% Î≥¥ÎÑàÏä§</p>
                </div>
              </div>
              <div class="companion-card">
                <div class="companion-image" style="background-color: #E1BEE7;">
                  <span class="companion-emoji">üßù‚Äç‚ôÄÔ∏è</span>
                </div>
                <div class="companion-info">
                  <h3>ÌîºÏóêÎÇò</h3>
                  <p>Î¨ºÍ≥†Í∏∞ Í∞ÄÍ≤© +10% Î≥¥ÎÑàÏä§</p>
                </div>
              </div>
              <div class="companion-card">
                <div class="companion-image" style="background-color: #BBDEFB;">
                  <span class="companion-emoji">üë©‚Äçüé§</span>
                </div>
                <div class="companion-info">
                  <h3>Ïï†ÎπÑÍ≤åÏùº</h3>
                  <p>Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞ ÌôïÎ•† +3% Î≥¥ÎÑàÏä§</p>
                </div>
              </div>
            </div>
            <div class="recruit-controls">
              <button id="recruitButton" class="recruit-button">ÎèôÎ£å Î™®ÏßëÌïòÍ∏∞ (Î≥ÑÏ°∞Í∞Å 1Í∞ú)</button>
              <div id="recruitResult" class="recruit-result"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="side-container">
      <div class="user-list-container">
        <div class="user-list-title">üë• Ï∞∏Ïó¨Ïûê Î™©Î°ù (<span id="userCount">0</span>Î™Ö)</div>
        <ul id="userList" class="user-list">
          <!-- Ï∞∏Ïó¨Ïûê Î™©Î°ùÏù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
        </ul>
      </div>
      
      <!-- ÎÇöÏãú Ï†ïÎ≥¥ ÏúÑÏ†Ø -->
      <div class="fishing-info-widget">
        <div class="fishing-info-header">
          <span class="fishing-info-title">üêü ÎÇöÏãú Ï†ïÎ≥¥</span>
          <span class="fishing-info-toggle">‚ñº</span>
        </div>
        <div class="fishing-info-content">
          <div id="currentFishInfo">Î°úÎî© Ï§ë...</div>
        </div>
      </div>
      
      <!-- ÎèôÎ£å ÌòÑÌô© ÏúÑÏ†Ø Ï∂îÍ∞Ä -->
      <div class="fishing-info-widget">
        <div class="fishing-info-header" style="background: linear-gradient(135deg, #9C27B0, #673AB7);">
          <span class="fishing-info-title">üë• ÎèôÎ£å ÌòÑÌô©</span>
          <span class="fishing-info-toggle">‚ñº</span>
        </div>
        <div class="fishing-info-content">
          <div id="companionStatus">
            <div class="skill-info" style="background: linear-gradient(to right, #f3e5f5, #e1bee7);">
              <div class="skill-level" style="color: #9C27B0;">ÎèôÎ£å Ï†ïÎ≥¥</div>
              <div class="skill-tip">Ìï®ÍªòÌïòÎäî ÏπúÍµ¨Îì§</div>
            </div>
            <div class="fish-card" style="text-align: center; border-left-color: #9C27B0;">
              <div style="width: 100%;">Î≥¥Ïú†Ìïú ÎèôÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ Ï∂îÍ∞Ä -->
  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeInventoryModal()">&times;</span>
      <h3 class="modal-title" id="modalTitle">ÏÇ¨Ïö©Ïûê Ïù∏Î≤§ÌÜ†Î¶¨</h3>
      <div id="inventoryContent" class="inventory-list">
        <!-- Ïù∏Î≤§ÌÜ†Î¶¨ Ìï≠Î™©Îì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê® -->
      </div>
    </div>
  </div>

  <script>
    // DOM ÏöîÏÜå Ï∞∏Ï°∞
    const authContainer = document.getElementById('authContainer');
    const chatContainer = document.getElementById('chatContainer');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const registerUsername = document.getElementById('registerUsername');
    const registerPassword = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const guestLoginBtn = document.getElementById('guestLoginBtn');
    const loginMessage = document.getElementById('loginMessage');
    const registerMessage = document.getElementById('registerMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfoText = document.getElementById('userInfoText');
    
    const statusText = document.getElementById('status');
    const messages = document.getElementById('messages');
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinButton');
    const userList = document.getElementById('userList');
    const userCountElement = document.getElementById('userCount');
    const tabs = document.querySelectorAll('.tab[data-tab]');
    const tabContents = document.querySelectorAll('.tab-content');

    let socket;
    let currentUsers = new Set();
    let isConnected = false;
    let currentUserData = []; // ÏÇ¨Ïö©Ïûê Î™©Î°ù Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
    let currentUser = {
      uuid: null,
      username: null,
      isGuest: true
    };

    // ÌÉ≠ Ï†ÑÌôò Í∏∞Îä• Ï∂îÍ∞Ä
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        // Î™®Îì† ÌÉ≠ÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        tabs.forEach(t => t.classList.remove('active'));
        
        // ÌòÑÏû¨ ÌÉ≠Ïóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        this.classList.add('active');
        
        // Î™®Îì† ÌÉ≠ Ïª®ÌÖêÏ∏† Ïà®ÍπÄ
        tabContents.forEach(content => content.classList.remove('active'));
        
        // ÌòÑÏû¨ ÌÉ≠Ïóê Ìï¥ÎãπÌïòÎäî Ïª®ÌÖêÏ∏† ÌëúÏãú
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId + 'Tab').classList.add('active');
        
        // ÏÉÅÏ†ê ÌÉ≠Ïù∏ Í≤ΩÏö∞ Ï¥àÍ∏∞ ÏïÑÏù¥ÌÖú Î°úÎìú
        if (tabId === 'shop') {
          const activeCategory = document.querySelector('.shop-category.active');
          if (activeCategory) {
            const category = activeCategory.getAttribute('data-category');
            filterShopItems(category);
          } else {
            // Í∏∞Î≥∏ ÌÉ≠(ÎÇöÏãúÎåÄ) ÌôúÏÑ±Ìôî
            const defaultTab = document.querySelector('.shop-category[data-category="rods"]');
            if (defaultTab) {
              defaultTab.classList.add('active');
              filterShopItems('rods');
            }
          }
        }
      });
    });

    const inventoryModal = document.getElementById('inventoryModal');
    const modalTitle = document.getElementById('modalTitle');
    const inventoryContent = document.getElementById('inventoryContent');

    // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î∂àÎü¨Ïò§Í∏∞
    function loadUserFromStorage() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
        if (currentUser.isGuest) {
          userInfoText.textContent = "Í≤åÏä§Ìä∏Î°ú Î°úÍ∑∏Ïù∏Îê®";
        } else {
          userInfoText.textContent = `${currentUser.username}ÏúºÎ°ú Î°úÍ∑∏Ïù∏Îê® (UUID: ${currentUser.uuid.substring(0, 8)}...)`;
        }
        
        // Ï±ÑÌåÖ ÌôîÎ©¥ Î≥¥Ïù¥Í∏∞
        authContainer.style.display = 'none';
        chatContainer.style.display = 'flex';
        
        // ÎÇöÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
        loadFishData();
        console.log("ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Î°úÎìú ÏôÑÎ£å - ÎÇöÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìò∏Ï∂úÎê®");
        
        // ÎèôÎ£å ÌòÑÌô© Ï¥àÍ∏∞Ìôî
        updateCompanionDisplay([]);
        
        // ÏûêÎèô Ï±ÑÌåÖ Ïó∞Í≤∞
        connectToChat();
      }
    }

    // Ï¥àÍ∏∞Ìôî Ïãú Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄ ÌôïÏù∏
    loadUserFromStorage();

    // Ìèº Ï†ÑÌôò Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    showRegisterBtn.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      loginMessage.textContent = '';
      loginMessage.className = 'auth-message';
    });

    showLoginBtn.addEventListener('click', () => {
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      registerMessage.textContent = '';
      registerMessage.className = 'auth-message';
    });

    // Í≤åÏä§Ìä∏ Î°úÍ∑∏Ïù∏
    guestLoginBtn.addEventListener('click', () => {
      currentUser = {
        uuid: null,
        username: null,
        isGuest: true
      };
      
      // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      // ÌôîÎ©¥ Ï†ÑÌôò
      authContainer.style.display = 'none';
      chatContainer.style.display = 'flex';
      userInfoText.textContent = "Í≤åÏä§Ìä∏Î°ú Î°úÍ∑∏Ïù∏Îê®";
      
      // ÎÇöÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú
      loadFishData();
      
      // ÏûêÎèô Ï±ÑÌåÖ Ïó∞Í≤∞
      connectToChat();
    });

    // Î°úÍ∑∏ÏïÑÏõÉ Í∏∞Îä•
    logoutBtn.addEventListener('click', () => {
      // ÏÜåÏºì Ïó∞Í≤∞ Ï¢ÖÎ£å
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        socket.close();
      }
      
      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï¥àÍ∏∞Ìôî
      currentUser = {
        uuid: null,
        username: null,
        isGuest: true
      };
      
      // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï†úÍ±∞
      localStorage.removeItem('currentUser');
      
      // ÌôîÎ©¥ Ï¥àÍ∏∞Ìôî
      messages.innerHTML = '';
      currentUsers.clear();
      updateUserList();
      form.style.display = 'none';
      
      // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ÏúºÎ°ú Ï†ÑÌôò
      chatContainer.style.display = 'none';
      authContainer.style.display = 'block';
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    });

    // ÌöåÏõêÍ∞ÄÏûÖ Í∏∞Îä•
    registerBtn.addEventListener('click', async () => {
      const username = registerUsername.value.trim();
      const password = registerPassword.value;
      const confirmPwd = confirmPassword.value;
      
      // ÏûÖÎ†• Í≤ÄÏ¶ù
      if (!username || !password) {
        registerMessage.textContent = 'ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
        registerMessage.className = 'auth-message error';
        return;
      }
      
      if (password !== confirmPwd) {
        registerMessage.textContent = 'ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.';
        registerMessage.className = 'auth-message error';
        return;
      }
      
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          registerMessage.textContent = data.message;
          registerMessage.className = 'auth-message success';
          
          // 3Ï¥à ÌõÑ Î°úÍ∑∏Ïù∏ ÌèºÏúºÎ°ú Ï†ÑÌôò
          setTimeout(() => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            loginUsername.value = username;
            registerMessage.textContent = '';
            registerMessage.className = 'auth-message';
          }, 3000);
        } else {
          registerMessage.textContent = data.message;
          registerMessage.className = 'auth-message error';
        }
      } catch (error) {
        registerMessage.textContent = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
        registerMessage.className = 'auth-message error';
      }
    });

    // Î°úÍ∑∏Ïù∏ Í∏∞Îä•
    loginBtn.addEventListener('click', async () => {
      const username = loginUsername.value.trim();
      const password = loginPassword.value;
      
      // ÏûÖÎ†• Í≤ÄÏ¶ù
      if (!username || !password) {
        loginMessage.textContent = 'ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÍ≥º ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î™®Îëê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.';
        loginMessage.className = 'auth-message error';
        return;
      }
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          loginMessage.textContent = data.message;
          loginMessage.className = 'auth-message success';
          
          // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÄÏû•
          currentUser = {
            uuid: data.uuid,
            username: data.username,
            isGuest: false
          };
          
          // Î°úÏª¨Ïä§ÌÜ†Î¶¨ÏßÄÏóê Ï†ÄÏû•
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú
          userInfoText.textContent = `${currentUser.username}ÏúºÎ°ú Î°úÍ∑∏Ïù∏Îê® (UUID: ${currentUser.uuid.substring(0, 8)}...)`;
          
          // ÎÇöÏãú Îç∞Ïù¥ÌÑ∞ Î°úÎìú (ÏÉàÎ°úÏö¥ ÏΩîÎìú)
          loadFishData();
          
          // ÌôîÎ©¥ Ï†ÑÌôò
          setTimeout(() => {
            authContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            loginMessage.textContent = '';
            loginMessage.className = 'auth-message';
            
            // ÏûêÎèô Ï±ÑÌåÖ Ïó∞Í≤∞
            connectToChat();
          }, 1500);
        } else {
          loginMessage.textContent = data.message;
          loginMessage.className = 'auth-message error';
        }
      } catch (error) {
        loginMessage.textContent = 'ÏÑúÎ≤Ñ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.';
        loginMessage.className = 'auth-message error';
      }
    });

    // ÌÉ≠ Ï†ÑÌôò Í∏∞Îä•
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // Î™®Îì† ÌÉ≠ÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
        tabs.forEach(t => t.classList.remove('active'));
        
        // ÌòÑÏû¨ ÌÉ≠Ïóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
        this.classList.add('active');
        
        // Î™®Îì† ÌÉ≠ Ïª®ÌÖêÏ∏† Ïà®ÍπÄ
        tabContents.forEach(content => content.classList.remove('active'));
        
        // ÌòÑÏû¨ ÌÉ≠Ïóê Ìï¥ÎãπÌïòÎäî Ïª®ÌÖêÏ∏† ÌëúÏãú
        const tabId = this.getAttribute('data-tab');
        document.getElementById(tabId + 'Tab').classList.add('active');
        
        // ÏÉÅÏ†ê ÌÉ≠Ïù∏ Í≤ΩÏö∞ Ï¥àÍ∏∞ ÏïÑÏù¥ÌÖú Î°úÎìú
        if (tabId === 'shop') {
          const activeCategory = document.querySelector('.shop-category.active');
          if (activeCategory) {
            const category = activeCategory.getAttribute('data-category');
            filterShopItems(category);
          } else {
            // Í∏∞Î≥∏ ÌÉ≠(ÎÇöÏãúÎåÄ) ÌôúÏÑ±Ìôî
            const defaultTab = document.querySelector('.shop-category[data-category="rods"]');
            if (defaultTab) {
              defaultTab.classList.add('active');
              filterShopItems('rods');
            }
          }
        }
      });
    });

    // ÏÉÅÏ†ê Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ÑÌôò Í∏∞Îä•
    document.addEventListener('DOMContentLoaded', () => {
      const shopCategories = document.querySelectorAll('.shop-category');
      
      shopCategories.forEach(category => {
        category.addEventListener('click', () => {
          shopCategories.forEach(c => c.classList.remove('active'));
          category.classList.add('active');
          
          const categoryId = category.getAttribute('data-category');
          loadShopItems(categoryId);
        });
      });
      
      // Ï¥àÍ∏∞Ïóê ÎÇöÏãúÎåÄ Ïπ¥ÌÖåÍ≥†Î¶¨ Î°úÎìú
      if (document.querySelector('#shopTab.active')) {
        loadShopItems('rods');
      }
      
      // ÏûÖÏû• Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
      if (joinBtn) {
        joinBtn.onclick = () => {
          const room = roomInput.value.trim() || 'Í∏∞Î≥∏Î∞©';
          
          // ÎãâÎÑ§ÏûÑ ÏÑ§Ï†ï (Î°úÍ∑∏Ïù∏Îêú ÏÇ¨Ïö©ÏûêÎäî ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ, Í≤åÏä§Ìä∏Îäî ÏûÑÏùò Ïù¥Î¶Ñ)
          let nickname;
          if (!currentUser.isGuest && currentUser.username) {
            nickname = currentUser.username;
          } else {
            nickname = 'Guest_' + Math.floor(Math.random() * 10000);
          }

          // Í∏∞Ï°¥ Ïó∞Í≤∞Ïù¥ ÏûàÏúºÎ©¥ Îã´Í∏∞
          if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
            socket.close();
          }

          connect(nickname, room);
          console.log('ÏûÖÏû• ÏãúÎèÑ:', nickname, room);
        };
      }
    });

    // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú Î°úÎìú Ìï®Ïàò
    function loadShopItems(category) {
      const container = document.getElementById('shop-items-container');
      if (!container) return;
      
      container.innerHTML = ''; // Í∏∞Ï°¥ ÎÇ¥Ïö© ÎπÑÏö∞Í∏∞
      
      // Ïπ¥ÌÖåÍ≥†Î¶¨Í∞Ä Ïú†Ìö®ÌïúÏßÄ ÌôïÏù∏
      if (category !== 'rods' && category !== 'accessories' && category !== 'items') {
        container.innerHTML = '<div class="shop-notice">Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïπ¥ÌÖåÍ≥†Î¶¨ÏûÖÎãàÎã§.</div>';
        return;
      }
      
      // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÏïÑÏù¥ÌÖú ÌïÑÌÑ∞ÎßÅ
      const categoryItems = Object.entries(shopItems).filter(([_, item]) => item.category === category);
      
      if (categoryItems.length === 0) {
        container.innerHTML = '<div class="shop-notice">Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨ÏóêÎäî ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</div>';
        return;
      }
      
      // ÏïÑÏù¥ÌÖú Î™©Î°ù ÏÉùÏÑ±
      categoryItems.forEach(([itemName, details]) => {
        const itemElement = document.createElement('div');
        itemElement.className = 'shop-item';
        
        let priceText = '';
        if (details.materialsRequired) {
          const materials = Object.entries(details.materialsRequired)
            .map(([material, quantity]) => `${material} ${quantity}Í∞ú`)
            .join(', ');
          priceText = `üíé ÌïÑÏöî Ïû¨Î£å: ${materials}`;
        } else if (details.favorability) {
          priceText = `‚ú® ${formatPrice(details.price)} Ìò∏Í∞êÎèÑ`;
        } else {
          priceText = `üí∞ ${formatPrice(details.price)} Í≥®Îìú`;
        }
        
        itemElement.innerHTML = `
          <div class="shop-item-info">
            <div class="shop-item-name">${itemName}</div>
            <div class="shop-item-desc">${details.description}</div>
            <div class="shop-item-price">${priceText}</div>
          </div>
          <button class="buy-button" data-item="${itemName}" data-price="${details.price || 0}">Íµ¨Îß§ÌïòÍ∏∞</button>
        `;
        
        container.appendChild(itemElement);
      });
      
      // Íµ¨Îß§ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
      setupBuyButtons();
    }

    // Ïà´ÏûêÎ•º 1,000 Îã®ÏúÑÎ°ú ','Î•º Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
    function formatPrice(price) {
      price = price != null ? price : 0;
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú Î™©Î°ù
    const shopItems = {
      // === ÎÇöÏãúÎåÄ Î™©Î°ù ===
      "ÎÇ°ÏùÄÎÇöÏãúÎåÄ": { price: 10000, requires: null, fishingSkill: 1, category: "rods", description: "Í∏∞Î≥∏Ï†ÅÏù∏ ÎÇöÏãúÎ•º Ìï† Ïàò ÏûàÎäî ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÏùºÎ∞òÎÇöÏãúÎåÄ": { price: 60000, requires: "ÎÇ°ÏùÄÎÇöÏãúÎåÄ", fishingSkill: 2, category: "rods", description: "Ï°∞Í∏à Îçî ÌäºÌäºÌïú ÏùºÎ∞ò ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Îã®Îã®ÌïúÎÇöÏãúÎåÄ": { price: 140000, requires: "ÏùºÎ∞òÎÇöÏãúÎåÄ", fishingSkill: 3, category: "rods", description: "Îã®Îã®Ìïú Ïû¨ÏßàÎ°ú ÎßåÎì§Ïñ¥ÏßÑ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÏùÄÎÇöÏãúÎåÄ": { price: 370000, requires: "Îã®Îã®ÌïúÎÇöÏãúÎåÄ", fishingSkill: 4, category: "rods", description: "ÏùÄÏúºÎ°ú Ïû•ÏãùÎêú Í≥†Í∏â ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Í∏àÎÇöÏãúÎåÄ": { price: 820000, requires: "ÏùÄÎÇöÏãúÎåÄ", fishingSkill: 5, category: "rods", description: "Í∏àÏúºÎ°ú Ïû•ÏãùÎêú Îß§Ïö∞ Í≥†Í∏âÏä§Îü¨Ïö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Í∞ïÏ≤†ÎÇöÏãúÎåÄ": { price: 2390000, requires: "Í∏àÎÇöÏãúÎåÄ", fishingSkill: 6, category: "rods", description: "Í∞ïÏ≤†Î°ú Ï†úÏûëÎêú ÌäºÌäºÌïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÏÇ¨ÌååÏù¥Ïñ¥ÎÇöÏãúÎåÄ": { price: 6100000, requires: "Í∞ïÏ≤†ÎÇöÏãúÎåÄ", fishingSkill: 7, category: "rods", description: "ÏÇ¨ÌååÏù¥Ïñ¥Í∞Ä Î∞ïÌûå Ìù¨Í∑ÄÌïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Î£®ÎπÑÎÇöÏãúÎåÄ": { price: 15000000, requires: "ÏÇ¨ÌååÏù¥Ïñ¥ÎÇöÏãúÎåÄ", fishingSkill: 8, category: "rods", description: "Î£®ÎπÑÍ∞Ä Î∞ïÌûå Îß§Ïö∞ Ìù¨Í∑ÄÌïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Îã§Ïù¥ÏïÑÎ™¨ÎìúÎÇöÏãúÎåÄ": { price: 45000000, requires: "Î£®ÎπÑÎÇöÏãúÎåÄ", fishingSkill: 9, category: "rods", description: "Îã§Ïù¥ÏïÑÎ™¨ÎìúÍ∞Ä Î∞ïÌûå Ï†ÑÏÑ§Ï†ÅÏù∏ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Î†àÎìúÎã§Ïù¥ÏïÑÎ™¨ÎìúÎÇöÏãúÎåÄ": { price: 100000000, requires: "Îã§Ïù¥ÏïÑÎ™¨ÎìúÎÇöÏãúÎåÄ", fishingSkill: 10, category: "rods", description: "Î†àÎìú Îã§Ïù¥ÏïÑÎ™¨ÎìúÎ°ú Ï†úÏûëÎêú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Î≤öÍΩÉÎÇöÏãúÎåÄ": { price: 300000000, requires: "Î†àÎìúÎã§Ïù¥ÏïÑÎ™¨ÎìúÎÇöÏãúÎåÄ", fishingSkill: 11, category: "rods", description: "Î≤öÍΩÉ Î¨¥Îä¨Í∞Ä ÏÉàÍ≤®ÏßÑ ÏïÑÎ¶ÑÎã§Ïö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÍΩÉÎßùÏö∏ÎÇöÏãúÎåÄ": { price: 732000000, requires: "Î≤öÍΩÉÎÇöÏãúÎåÄ", fishingSkill: 12, category: "rods", description: "ÍΩÉÎßùÏö∏Ïù¥ ÌîºÏñ¥ÎÇòÎäî ÎìØÌïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ìò∏Î°±Î∂àÎÇöÏãúÎåÄ": { price: 1980000000, requires: "ÍΩÉÎßùÏö∏ÎÇöÏãúÎåÄ", fishingSkill: 13, category: "rods", description: "Ìò∏Î°±Î∂àÏ≤òÎüº ÎπõÎÇòÎäî Ïã†ÎπÑÎ°úÏö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÏÇ∞Ìò∏Îì±ÎÇöÏãúÎåÄ": { price: 4300000000, requires: "Ìò∏Î°±Î∂àÎÇöÏãúÎåÄ", fishingSkill: 14, category: "rods", description: "ÏÇ∞Ìò∏Ï≤òÎüº ÎπõÎÇòÎäî ÏïÑÎ¶ÑÎã§Ïö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÌîºÌÅ¨Îãâ": { price: 8800000000, requires: "ÏÇ∞Ìò∏Îì±ÎÇöÏãúÎåÄ", fishingSkill: 15, category: "rods", description: "ÌîºÌÅ¨Îãâ Î∞îÍµ¨Îãà ÌòïÌÉúÏùò ÎèÖÌäπÌïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÎßàÎÖÄÎπóÏûêÎ£®": { price: 25000000000, requires: "ÌîºÌÅ¨Îãâ", fishingSkill: 16, category: "rods", description: "ÎßàÎÖÄÏùò ÎπóÏûêÎ£® ÌòïÌÉúÏùò ÎßàÎ≤ïÏù¥ ÍπÉÎì† ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÏóêÌÖåÎ•¥ÎÇöÏãúÎåÄ": { price: 64800000000, requires: "ÎßàÎÖÄÎπóÏûêÎ£®", fishingSkill: 17, category: "rods", description: "ÏóêÌÖåÎ•¥ Î¨ºÏßàÎ°ú ÎßåÎì§Ïñ¥ÏßÑ Ï¥àÏûêÏó∞Ï†ÅÏù∏ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Î≥ÑÏ°∞Í∞ÅÎÇöÏãúÎåÄ": { price: 147600000000, requires: "ÏóêÌÖåÎ•¥ÎÇöÏãúÎåÄ", fishingSkill: 18, category: "rods", description: "Î≥ÑÏùò Ï°∞Í∞ÅÏúºÎ°ú ÎßåÎì§Ïñ¥ÏßÑ Ïö∞Ï£ºÏùò ÌûòÏù¥ ÍπÉÎì† ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ïó¨Ïö∞Íº¨Î¶¨ÎÇöÏãúÎåÄ": { price: 320000000000, requires: "Î≥ÑÏ°∞Í∞ÅÎÇöÏãúÎåÄ", fishingSkill: 19, category: "rods", description: "Ïó¨Ïö∞ Íº¨Î¶¨ Î™®ÏñëÏùò Ïã†ÎπÑÎ°úÏö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ï¥àÏΩúÎ¶øÎ°§ÎÇöÏãúÎåÄ": { price: 780000000000, requires: "Ïó¨Ïö∞Íº¨Î¶¨ÎÇöÏãúÎåÄ", fishingSkill: 20, category: "rods", description: "Ï¥àÏΩúÎ¶ø Î°§ÏºÄÏù¥ÌÅ¨Ï≤òÎüº ÏÉùÍ∏¥ Îã¨ÏΩ§Ìïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ìò∏Î∞ïÏú†Î†πÎÇöÏãúÎåÄ": { price: 2800000000000, requires: "Ï¥àÏΩúÎ¶øÎ°§ÎÇöÏãúÎåÄ", fishingSkill: 21, category: "rods", description: "Ìò∏Î∞ï Ïú†Î†πÏù¥ ÍπÉÎì† Í≥µÌè¨Ïä§Îü¨Ïö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "ÌïëÌÅ¨Î≤ÑÎãàÎÇöÏãúÎåÄ": { price: 6100000000000, requires: "Ìò∏Î∞ïÏú†Î†πÎÇöÏãúÎåÄ", fishingSkill: 22, category: "rods", description: "ÌïëÌÅ¨ÏÉâ ÌÜ†ÎÅº Î™®ÏñëÏùò Í∑ÄÏó¨Ïö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ìï†Î°úÏö∞ÎÇöÏãúÎåÄ": { price: 15100000000000, requires: "ÌïëÌÅ¨Î≤ÑÎãàÎÇöÏãúÎåÄ", fishingSkill: 23, category: "rods", description: "Ìï†Î°úÏúà ÌÖåÎßàÏùò ÏúºÏä§Ïä§Ìïú ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },
      "Ïó¨Ïö∞Î∂àÎÇöÏãúÎåÄ": { price: 40400000000000, requires: "Ìï†Î°úÏö∞ÎÇöÏãúÎåÄ", fishingSkill: 24, category: "rods", description: "Ïó¨Ïö∞Î∂àÏù¥ ÍπÉÎì† Ïã†ÎπÑÎ°úÏö¥ ÎÇöÏãúÎåÄÏûÖÎãàÎã§." },

      // === ÏïÖÏÑ∏ÏÇ¨Î¶¨ Î™©Î°ù ===
      "Ïò§ÎûòÎêúÎ∞òÏßÄ": { price: 0, requires: null, fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 5 }, description: "ÎÇöÏãú Ïø®ÌÉÄÏûÑÏùÑ 5% Í∞êÏÜåÏãúÌÇ§Îäî Ïò§ÎûòÎêú Î∞òÏßÄÏûÖÎãàÎã§." },
      "ÏùÄÎ™©Í±∏Ïù¥": { price: 0, requires: "Ïò§ÎûòÎêúÎ∞òÏßÄ", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 15 }, description: "ÎÇöÏãú Ïø®ÌÉÄÏûÑÏùÑ 10% Í∞êÏÜåÏãúÌÇ§Îäî ÏùÄÎ™©Í±∏Ïù¥ÏûÖÎãàÎã§." },
      "Í∏àÍ∑ÄÍ±∏Ïù¥": { price: 0, requires: "ÏùÄÎ™©Í±∏Ïù¥", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 35 }, description: "ÎÇöÏãú Ïø®ÌÉÄÏûÑÏùÑ 15% Í∞êÏÜåÏãúÌÇ§Îäî Í∏àÍ∑ÄÍ±∏Ïù¥ÏûÖÎãàÎã§." },
      "ÎßàÎ≤ïÏùòÌéúÎçòÌä∏": { price: 0, requires: "Í∏àÍ∑ÄÍ±∏Ïù¥", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 60 }, description: "ÎÇöÏãú Ïø®ÌÉÄÏûÑÏùÑ 20% Í∞êÏÜåÏãúÌÇ§Îäî ÎßàÎ≤ïÏùò ÌéúÎçòÌä∏ÏûÖÎãàÎã§." },
      "ÏóêÎ©îÎûÑÎìúÎ∏åÎ°úÏπò": { price: 0, requires: "ÎßàÎ≤ïÏùòÌéúÎçòÌä∏", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 100 }, description: "ÌåêÎß§ Í∏àÏï°Ïù¥ 5% Ï¶ùÍ∞ÄÌïòÎäî ÏóêÎ©îÎûÑÎìú Î∏åÎ°úÏπòÏûÖÎãàÎã§." },
      "ÌÜ†ÌååÏ¶àÏù¥Ïñ¥ÎßÅ": { price: 0, requires: "ÏóêÎ©îÎûÑÎìúÎ∏åÎ°úÏπò", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 180 }, description: "ÌåêÎß§ Í∏àÏï°Ïù¥ 10% Ï¶ùÍ∞ÄÌïòÎäî ÌÜ†ÌååÏ¶à Ïù¥Ïñ¥ÎßÅÏûÖÎãàÎã§." },
      "ÏûêÏàòÏ†ïÌåîÏ∞å": { price: 0, requires: "ÌÜ†ÌååÏ¶àÏù¥Ïñ¥ÎßÅ", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 300 }, description: "ÌåêÎß§ Í∏àÏï°Ïù¥ 15% Ï¶ùÍ∞ÄÌïòÎäî ÏûêÏàòÏ†ï ÌåîÏ∞åÏûÖÎãàÎã§." },
      "Î∞±Í∏àÌã∞ÏïÑÎùº": { price: 0, requires: "ÏûêÏàòÏ†ïÌåîÏ∞å", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 465 }, description: "ÌåêÎß§ Í∏àÏï°Ïù¥ 20% Ï¶ùÍ∞ÄÌïòÎäî Î∞±Í∏à Ìã∞ÏïÑÎùºÏûÖÎãàÎã§." },
      "ÎßåÎìúÎùºÍ≥†ÎùºÌóàÎ∏å": { price: 0, requires: "Î∞±Í∏àÌã∞ÏïÑÎùº", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 700 }, description: "Î¨ºÍ≥†Í∏∞ ÌöçÎìù ÌôïÎ•†Ïù¥ 5% Ï¶ùÍ∞ÄÌïòÎäî ÎßåÎìúÎùºÍ≥†Îùº ÌóàÎ∏åÏûÖÎãàÎã§." },
      "ÏóêÌÖåÎ•¥ÎÇòÎ¨¥Î¨òÎ™©": { price: 0, requires: "ÎßåÎìúÎùºÍ≥†ÎùºÌóàÎ∏å", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 1000 }, description: "Î¨ºÍ≥†Í∏∞ ÌöçÎìù ÌôïÎ•†Ïù¥ 10% Ï¶ùÍ∞ÄÌïòÎäî ÏóêÌÖåÎ•¥ÎÇòÎ¨¥ Î¨òÎ™©ÏûÖÎãàÎã§." },
      "Î™ΩÎßàÏùòÏ°∞Í∞ÅÏÉÅ": { price: 0, requires: "ÏóêÌÖåÎ•¥ÎÇòÎ¨¥Î¨òÎ™©", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 1800 }, description: "Î¨ºÍ≥†Í∏∞ ÌöçÎìù ÌôïÎ•†Ïù¥ 15% Ï¶ùÍ∞ÄÌïòÎäî Î™ΩÎßàÏùò Ï°∞Í∞ÅÏÉÅÏûÖÎãàÎã§." },
      "ÎßàÏπ¥Î°±ÌõàÏû•": { price: 0, requires: "Î™ΩÎßàÏùòÏ°∞Í∞ÅÏÉÅ", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 3200 }, description: "Î¨ºÍ≥†Í∏∞ ÌöçÎìù ÌôïÎ•†Ïù¥ 20% Ï¶ùÍ∞ÄÌïòÎäî ÎßàÏπ¥Î°± ÌõàÏû•ÏûÖÎãàÎã§." },
      "ÎπõÎÇòÎäîÎßàÎ†•ÏàúÌôòÏ≤¥": { price: 0, requires: "ÎßàÏπ¥Î°±ÌõàÏû•", fishingSkill: 0, category: "accessories", materialsRequired: { "Ìò∏Î∞ïÏÑù": 5000 }, description: "Î¨ºÍ≥†Í∏∞ ÌöçÎìù ÌôïÎ•†Ïù¥ 25% Ï¶ùÍ∞ÄÌïòÎäî ÎπõÎÇòÎäî ÎßàÎ†• ÏàúÌôòÏ≤¥ÏûÖÎãàÎã§." },

      // === Í∏∞ÌÉÄ ÏïÑÏù¥ÌÖú ===
      "Ìò∏Î∞ïÏÑù": { price: 500, requires: null, category: "items", favorability: true, description: "Ïó¨Îü¨ ÏïÖÏÑ∏ÏÇ¨Î¶¨Î•º ÎßåÎìúÎäîÎç∞ ÌïÑÏöîÌïú Ïû¨Î£åÏûÖÎãàÎã§." },
      "Î¶¨ÌÉÄÏùòÏùºÏßÄ": { price: 0, requires: null, category: "items", materialsRequired: { "Î≥ÑÏ°∞Í∞Å": 1 }, description: "Î¶¨ÌÉÄÏùò ÎÇöÏãú ÏùºÏßÄÏûÖÎãàÎã§. ÏùΩÏúºÎ©¥ ÎÇöÏãú ÏßÄÏãùÏùÑ ÏñªÏùÑ Ïàò ÏûàÏäµÎãàÎã§." },
      "Ìò∏Î∞ïÏÑùÎ≠âÏπò": { price: 0, requires: null, category: "items", materialsRequired: { "Î≥ÑÏ°∞Í∞Å": 1 }, description: "Ìò∏Î∞ïÏÑù 15Í∞úÎ•º ÏñªÏùÑ Ïàò ÏûàÎäî Î≠âÏπòÏûÖÎãàÎã§." },
      "Ìò∏Î∞ïÏÑùÍæ∏Îü¨ÎØ∏": { price: 0, requires: null, category: "items", materialsRequired: { "Î≥ÑÏ°∞Í∞Å": 5 }, description: "Ìò∏Î∞ïÏÑù 80Í∞úÎ•º ÏñªÏùÑ Ïàò ÏûàÎäî Íæ∏Îü¨ÎØ∏ÏûÖÎãàÎã§." },
      "Ïó∞Í∏àÏà†Ìè¨ÏÖò": { price: 0, requires: null, category: "items", materialsRequired: { "Î≥ÑÏ°∞Í∞Å": 1 }, description: "ÎßàÏãúÎ©¥ ÏùºÏãúÏ†ÅÏúºÎ°ú ÎÇöÏãú Îä•Î†•Ïù¥ Ìñ•ÏÉÅÎêòÎäî Ìè¨ÏÖòÏûÖÎãàÎã§." }
    };

    // Íµ¨Îß§ Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
    function setupBuyButtons() {
      const buyButtons = document.querySelectorAll('.buy-button');
      buyButtons.forEach(button => {
        button.addEventListener('click', () => {
          if (!isConnected) {
            alert('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§. Î®ºÏ†Ä Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•ÌïòÏÑ∏Ïöî.');
            return;
          }
          
          const itemName = button.getAttribute('data-item');
          const item = shopItems[itemName];
          
          socket.send(JSON.stringify({ 
            type: 'buy', 
            item: itemName,
            price: item.price || 0
          }));
        });
      });
    }

    function updateUserList() {
      const userListElement = document.getElementById('userList');
      userListElement.innerHTML = '';
      
      console.log('updateUserList Ìò∏Ï∂úÎê®, ÏÇ¨Ïö©Ïûê Ïàò:', currentUserData.length);
      
      currentUserData.forEach(user => {
        const listItem = document.createElement('li');
        listItem.className = 'user-item';
        listItem.textContent = user.nickname;
        
        // ÎãâÎÑ§ÏûÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
        listItem.addEventListener('click', () => {
          console.log('ÏÇ¨Ïö©Ïûê ÌÅ¥Î¶≠Îê®:', user.nickname, 'userId:', user.userId);
          if (user.userId) {
            requestUserInventory(user.userId, user.nickname);
          } else {
            alert('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.');
          }
        });
        
        userListElement.appendChild(listItem);
      });
      
      userCountElement.textContent = currentUserData.length;
    }

    // Ï¥àÍ∏∞ Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
    updateUserList();

    // Î©îÏãúÏßÄÎ•º Ï±ÑÌåÖÏóê Ï∂îÍ∞ÄÌïòÎäî Ìï®Ïàò
    function addMessage(msg, type = 'chat') {
      if (type === 'join' && msg.userId && msg.nickname) {
        // join Î©îÏãúÏßÄ: ÎãâÎÑ§ÏûÑÏùÑ ÌÅ¥Î¶≠ Í∞ÄÎä•ÌïòÎèÑÎ°ù ÌëúÏãú
        const div = document.createElement('div');
        const timeMatch = msg.text.match(/^\[.*?\]/);
        const timeStr = timeMatch ? timeMatch[0] : '';
        const prefix = " üí¨ ";
        const suffix = "ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§.";
        div.innerHTML = `${timeStr}${prefix}<span class="userNickname" data-userid="${msg.userId}">${msg.nickname}</span>${suffix}`;
        div.querySelector('.userNickname').onclick = function () {
          const targetUserId = this.getAttribute('data-userid');
          socket.send(JSON.stringify({ type: 'requestUserInfo', targetUserId }));
        };
        messages.appendChild(div);
      } else if (type === 'leave' && msg.nickname) {
        // Ìá¥Ïû• Î©îÏãúÏßÄ ÌëúÏãú
        const div = document.createElement('div');
        div.textContent = msg.text;
        messages.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.textContent = typeof msg === 'string' ? msg : msg.text;
        messages.appendChild(div);
      }
      messages.scrollTop = messages.scrollHeight;
    }

    // Ïó∞Í≤∞ Ìï®Ïàò
    function connect(nickname, room) {
      console.log('Ïó∞Í≤∞ ÏãúÎèÑ:', nickname, room);
      
      // ÌòÑÏû¨ Ìò∏Ïä§Ìä∏ Í∏∞Î∞òÏúºÎ°ú WebSocket URL ÏÉùÏÑ±
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host || 'localhost:3000'; // Î°úÏª¨ ÌÖåÏä§Ìä∏Ïö© Í∏∞Î≥∏Í∞í Ï∂îÍ∞Ä
      
      try {
        socket = new WebSocket(`${protocol}//${host}`);
        
        socket.addEventListener('open', function(event) {
          // Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï†ÑÏÜ°
          socket.send(JSON.stringify({
            type: 'join',
            nickname: currentUser.username || nickname,
            room: room,
            uuid: currentUser.uuid  // UUID Ï†ÑÏÜ°
          }));
          
          statusText.innerHTML = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú: <span style="color:green;">Ïó∞Í≤∞Îê®</span>';
          form.style.display = 'flex';
          input.focus();
          isConnected = true;
          
          // Ïó∞Í≤∞ ÏßÅÌõÑ Î≥∏Ïù∏Ïùò ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏöîÏ≤≠ (ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ ÏúÑÌï¥)
          // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏù∏ Í≤ΩÏö∞ÏóêÎßå Î≥∏Ïù∏ Ï†ïÎ≥¥ ÏöîÏ≤≠
          if (currentUser.uuid) {
            setTimeout(() => {
              console.log("Î≥∏Ïù∏ Ï†ïÎ≥¥ ÏöîÏ≤≠ Ï†ÑÏÜ° (UUID:", currentUser.uuid, ")");
              // ÏûêÎèô Ï†ïÎ≥¥ ÏöîÏ≤≠ÏùÄ Î™®Îã¨ ÌëúÏãú ÏóÜÏù¥ ÏßÑÌñâ
              socket.send(JSON.stringify({
                type: 'requestUserInfo',
                targetUserId: currentUser.uuid,
                autoRequest: true  // ÏûêÎèô ÏöîÏ≤≠ÏûÑÏùÑ ÌëúÏãú
              }));
            }, 2000);
          } else {
            console.log("Í≤åÏä§Ìä∏Î°ú Ï†ëÏÜç Ï§ëÏù¥ÎØÄÎ°ú Î≥∏Ïù∏ Ï†ïÎ≥¥ ÏöîÏ≤≠ ÏÉùÎûµ");
            // Í∏∞Î≥∏ ÎÇöÏãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateFishInfoDisplay();
          }
        });

        socket.addEventListener('error', function(event) {
          console.error('WebSocket Ïò§Î•ò:', event);
          statusText.innerHTML = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú: <span style="color:red;">Ïó∞Í≤∞ Ïò§Î•ò</span>';
          alert('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
        });

        socket.onmessage = (event) => {
          console.log('Î©îÏãúÏßÄ ÏàòÏã†:', event.data);
          let data;
          try {
            data = JSON.parse(event.data);
          } catch (e) {
            data = { type: 'chat', text: event.data };
          }
          
          // Î©îÏãúÏßÄ ÌÉÄÏûÖÏóê Îî∞Î•∏ Ï≤òÎ¶¨
          if (data.type === 'join') {
            addMessage(data, 'join');
          } else if (data.type === 'leave') {
            addMessage(data, 'leave');
          } else if (data.type === 'userInfo') {
            console.log('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏàòÏã†:', data);
            
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÏûòÎ™ªÎêú Í≤ΩÏö∞ Ï≤òÎ¶¨
            if (!data.userId) {
              console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©Ïûê ID:', data);
              return;
            }
            
            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï∞æÍ∏∞ - currentUserDataÍ∞Ä Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
            if (!Array.isArray(currentUserData)) {
              currentUserData = [];
            }
            
            // ÏÇ¨Ïö©Ïûê Ï∞æÍ∏∞
            const userInfo = currentUserData.find(user => user.userId === data.userId);
            let clickedUserNickname;
            
            if (userInfo) {
              clickedUserNickname = userInfo.nickname;
              console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï∞æÏùå: ${clickedUserNickname}`);
            } else {
              // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÎäî Í≤ΩÏö∞ ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏù∏ÏßÄ ÌôïÏù∏
              if (data.userId === currentUser.uuid) {
                clickedUserNickname = currentUser.username || 'Î≥∏Ïù∏';
                console.log(`ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥: ${clickedUserNickname}`);
              } else {
                clickedUserNickname = 'Ïïå Ïàò ÏóÜÏùå';
                console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå, userId: ${data.userId}`);
              }
            }
            
            console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú: ${clickedUserNickname}, Ïù∏Î≤§ÌÜ†Î¶¨: `, data.inventory);
            console.log(`ÏÇ¨Ïö©Ïûê Í≥®Îìú: ${data.gold}, Ïä§ÌÇ¨ Î†àÎ≤®: ${data.skillLevel}`);
            
            // Î≥∏Ïù∏ Ï†ïÎ≥¥Ïù∏ Í≤ΩÏö∞ Ïä§ÌÇ¨ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
            if (data.userId === currentUser.uuid && data.skillLevel !== undefined) {
              localStorage.setItem('fishingSkillLevel', data.skillLevel.toString());
              console.log(`ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®(${data.skillLevel})ÏùÑ Ï†ÄÏû•ÌñàÏäµÎãàÎã§.`);
              // ÎÇöÏãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
              updateFishInfoDisplay();
              
              // ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
              if (data.companions) {
                updateCompanionDisplay(data.companions);
              }
            }
            
            // ÏûêÎèô ÏöîÏ≤≠Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ ÌëúÏãú
            if (inventoryModalRequested && !data.autoRequest) {
              showInventoryModal(
                clickedUserNickname,
                data.inventory || {},
                data.gold || 0,
                data.skillLevel || 1
              );
              // ÏöîÏ≤≠ ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
              inventoryModalRequested = false;
            }
          } else if (data.type === 'user_list') {
            // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Ï≤òÎ¶¨
            currentUserData = data.users;
            console.log('ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏:', currentUserData);
            updateUserList();
          } else if (data.type === 'full_user_list') {
            // Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Î™©Î°ùÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
            currentUserData = data.users;
            console.log('Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏:', currentUserData);
            updateUserList();
          } else if (data.type === 'recruitResult') {
            // ÎèôÎ£å Î™®Ïßë Í≤∞Í≥º Ï≤òÎ¶¨
            const recruitButton = document.getElementById('recruitButton');
            const recruitResult = document.getElementById('recruitResult');
            
            // Î≤ÑÌäº ÌôúÏÑ±Ìôî
            if (recruitButton) recruitButton.disabled = false;
            
            if (data.success) {
              // ÏÑ±Í≥µ Ïãú Ï≤òÎ¶¨
              const companion = data.companion;
              let companionEmoji = 'üë§';
              let companionColor = '#673AB7';
              
              // Ìï¥Îãπ ÎèôÎ£å Ï∞æÍ∏∞
              const companionType = companionTypes.find(type => type.id === companion.id);
              if (companionType) {
                companionEmoji = companionType.emoji;
                companionColor = companionType.color;
              }
              
              // Í≤∞Í≥º Î©îÏãúÏßÄ ÌëúÏãú
              recruitResult.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                  <span style="font-size: 2em;">${companionEmoji}</span>
                  <div>
                    <div style="font-size: 1.2em; color: ${companionColor};">${companion.name} ÎèôÎ£å ÌöçÎìù!</div>
                    <div style="font-size: 0.9em; color: #555;">${companion.bonus}</div>
                  </div>
                </div>
              `;
              recruitResult.className = 'recruit-result recruit-success';
              
              // ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
              if (data.companions) {
                updateCompanionDisplay(data.companions);
              }
              
              // ÏÑ±Í≥µ Î©îÏãúÏßÄ Ï±ÑÌåÖÏ∞ΩÏóê ÌëúÏãú
              addMessage(`üéâ Ï∂ïÌïòÌï©ÎãàÎã§! ${companion.name} ÎèôÎ£åÎ•º ÏñªÏóàÏäµÎãàÎã§!`);
            } else {
              // Ïã§Ìå® Ïãú Ï≤òÎ¶¨
              if (data.error === 'no_star_fragment') {
                recruitResult.textContent = 'Î≥ÑÏ°∞Í∞ÅÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Î≥ÑÏ°∞Í∞ÅÏùÑ ÏñªÏùÄ ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
              } else if (data.error === 'already_has_companion') {
                recruitResult.textContent = 'Ïù¥ÎØ∏ Î≥¥Ïú†Ìïú ÎèôÎ£åÏûÖÎãàÎã§. Îã§Î•∏ ÎèôÎ£åÎ•º ÎΩëÏùÑ ÌôïÎ•†Ïù¥ ÎÜíÏïÑÏßëÎãàÎã§!';
              } else if (data.error === 'not_authenticated') {
                recruitResult.textContent = 'Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
              } else {
                recruitResult.textContent = 'ÎèôÎ£å Î™®ÏßëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
              }
              recruitResult.className = 'recruit-result recruit-fail';
            }
          } else if (data.type === 'companions') {
            // ÎèôÎ£å Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
            if (data.companions) {
              updateCompanionDisplay(data.companions);
            }
          } else {
            addMessage(data);
          }
        };

        socket.onclose = () => {
          console.log('ÏÜåÏºì Ïó∞Í≤∞ Ï¢ÖÎ£å');
          statusText.innerHTML = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú: <span style="color:red;">Ïó∞Í≤∞ Ï¢ÖÎ£å</span>';
          addMessage('‚ùå ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï¢ÖÎ£åÎê®');
          form.style.display = 'none';
          currentUsers.clear();
          updateUserList();
          isConnected = false;
        };

        form.onsubmit = (e) => {
          e.preventDefault();
          if (!input.value.trim()) return;
          socket.send(JSON.stringify({ type: 'message', text: input.value.trim() }));
          input.value = '';
        };
      } catch (error) {
        console.error('Ïó∞Í≤∞ Ïò§Î•ò:', error);
        statusText.innerHTML = 'ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÉÅÌÉú: <span style="color:red;">Ïó∞Í≤∞ Ïã§Ìå®</span>';
        alert('ÏÑúÎ≤Ñ Ïó∞Í≤∞Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + error.message);
      }
    }

    // ÏÇ¨Ïö©Ïûê Ïù∏Î≤§ÌÜ†Î¶¨ ÏöîÏ≤≠ Ìï®Ïàò
    function requestUserInventory(userId, nickname) {
      if (!isConnected) {
        alert('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§.');
        return;
      }
      
      if (!userId) {
        console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©Ïûê ID:', userId);
        alert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©Ïûê IDÏûÖÎãàÎã§.');
        return;
      }
      
      console.log(`${nickname}(${userId})Ïùò Ï†ïÎ≥¥ ÏöîÏ≤≠ Ï§ë...`);
      
      // ÏöîÏ≤≠ Ï†ÑÏÜ° Ï†Ñ Î°úÎî© Î©îÏãúÏßÄ ÌëúÏãú
      showInventoryModal(nickname, {}, 0, 0, true);
      
      // Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ ÌëúÏãú ÏöîÏ≤≠ ÌîåÎûòÍ∑∏ ÏÑ§Ï†ï
      inventoryModalRequested = true;
      
      // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏöîÏ≤≠ Ï†ÑÏÜ°
      socket.send(JSON.stringify({
        type: 'requestUserInfo',
        targetUserId: userId
      }));
    }
    
    // Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ ÌëúÏãú Ìï®Ïàò
    function showInventoryModal(nickname, inventory, gold, skillLevel, isLoading = false) {
      modalTitle.textContent = `${nickname}ÎãòÏùò Ïù∏Î≤§ÌÜ†Î¶¨`;
      
      // Ïù∏Î≤§ÌÜ†Î¶¨ ÎÇ¥Ïö© ÌëúÏãú
      inventoryContent.innerHTML = '';
      
      if (isLoading) {
        const loadingMessage = document.createElement('div');
        loadingMessage.textContent = 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...';
        loadingMessage.style.textAlign = 'center';
        loadingMessage.style.padding = '20px';
        inventoryContent.appendChild(loadingMessage);
        inventoryModal.style.display = 'block';
        return;
      }
      
      // Í≥®Îìú ÌëúÏãú
      const goldItem = document.createElement('div');
      goldItem.className = 'inventory-item';
      goldItem.innerHTML = `<span>üí∞ Í≥®Îìú</span><span class="gold-amount">${formatPrice(gold)} G</span>`;
      inventoryContent.appendChild(goldItem);
      
      // ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® ÌëúÏãú
      const skillItem = document.createElement('div');
      skillItem.className = 'inventory-item';
      skillItem.innerHTML = `<span>üé£ ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®</span><span>${skillLevel}</span>`;
      inventoryContent.appendChild(skillItem);
      
      // ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê Î≥∏Ïù∏Ïù∏ Í≤ΩÏö∞, ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏ Î∞è ÎÇöÏãú Ï†ïÎ≥¥ Í∞±Ïã†
      // ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏôÄ Î™®Îã¨Ïóê ÌëúÏãúÎêú ÏÇ¨Ïö©ÏûêÏùò ÎãâÎÑ§ÏûÑÏù¥ Í∞ôÏùÄ Í≤ΩÏö∞ ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
      const currentUserObj = JSON.parse(localStorage.getItem('currentUser') || '{}');
      if (currentUserObj.username === nickname) {
        // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóê ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® Ï†ÄÏû•
        localStorage.setItem('fishingSkillLevel', skillLevel.toString());
        // ÎÇöÏãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        updateFishInfoDisplay();
        console.log(`ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®Ïù¥ ${skillLevel}Î°ú ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`);
      }
      
      // Ïù∏Î≤§ÌÜ†Î¶¨ ÎÇ¥Ïö© Ïú†Ìö®ÏÑ± ÌôïÏù∏
      if (!inventory || typeof inventory !== 'object') {
        console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Ïù∏Î≤§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞:', inventory);
        const errorMessage = document.createElement('div');
        errorMessage.textContent = 'Ïù∏Î≤§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞Î•º Î°úÎìúÌï† Ïàò ÏóÜÏäµÎãàÎã§.';
        errorMessage.style.textAlign = 'center';
        errorMessage.style.padding = '10px';
        errorMessage.style.color = '#f44336';
        inventoryContent.appendChild(errorMessage);
        inventoryModal.style.display = 'block';
        return;
      }
      
      // Î¨ºÍ≥†Í∏∞ Î∞è ÏïÑÏù¥ÌÖú ÌëúÏãú
      let hasItems = false;
      
      // ÎÇöÏãúÎåÄ Í¥ÄÎ†® ÏïÑÏù¥ÌÖú ÌëúÏãú
      Object.keys(shopItems).forEach(itemName => {
        if (shopItems[itemName].category === 'rods' && inventory[itemName]) {
          hasItems = true;
          const rodItem = document.createElement('div');
          rodItem.className = 'inventory-item';
          rodItem.innerHTML = `<span>üé£ ${itemName}</span><span>${inventory[itemName]}Í∞ú</span>`;
          inventoryContent.appendChild(rodItem);
        }
      });
      
      // ÏïÖÏÑ∏ÏÇ¨Î¶¨ Í¥ÄÎ†® ÏïÑÏù¥ÌÖú ÌëúÏãú
      Object.keys(shopItems).forEach(itemName => {
        if (shopItems[itemName].category === 'accessories' && inventory[itemName]) {
          hasItems = true;
          const accessoryItem = document.createElement('div');
          accessoryItem.className = 'inventory-item';
          accessoryItem.innerHTML = `<span>üíç ${itemName}</span><span>${inventory[itemName]}Í∞ú</span>`;
          inventoryContent.appendChild(accessoryItem);
        }
      });
      
      // Î¨ºÍ≥†Í∏∞ ÌëúÏãú
      const fishItems = Object.keys(inventory).filter(itemName => 
        fishTypes.some(fish => fish.name === itemName)
      ).sort((a, b) => {
        const fishA = fishTypes.find(f => f.name === a);
        const fishB = fishTypes.find(f => f.name === b);
        return (fishA?.price || 0) - (fishB?.price || 0);
      });
      
      if (fishItems.length > 0) {
        hasItems = true;
        const fishHeader = document.createElement('div');
        fishHeader.className = 'inventory-category';
        fishHeader.textContent = 'üêü Î¨ºÍ≥†Í∏∞';
        inventoryContent.appendChild(fishHeader);
        
        fishItems.forEach(fishName => {
          const fish = fishTypes.find(f => f.name === fishName);
          const fishItem = document.createElement('div');
          fishItem.className = 'inventory-item';
          fishItem.innerHTML = `<span>üêü ${fishName}</span><span>${inventory[fishName]}Í∞ú (${formatPrice(fish?.price || 0)}Ïõê)</span>`;
          inventoryContent.appendChild(fishItem);
        });
      }
      
      // Í∏∞ÌÉÄ ÏïÑÏù¥ÌÖúÎì§ ÌëúÏãú (ÎÇöÏãúÎåÄ, ÏïÖÏÑ∏ÏÇ¨Î¶¨, Î¨ºÍ≥†Í∏∞Í∞Ä ÏïÑÎãå Í≤ÉÎì§)
      const otherItems = Object.keys(inventory).filter(itemName => 
        !fishItems.includes(itemName) && 
        !Object.keys(shopItems).some(shopItem => shopItem === itemName)
      );
      
      if (otherItems.length > 0) {
        hasItems = true;
        const otherHeader = document.createElement('div');
        otherHeader.className = 'inventory-category';
        otherHeader.textContent = 'üß™ Ïû¨Î£å';
        inventoryContent.appendChild(otherHeader);
        
        otherItems.forEach(itemName => {
          if (inventory[itemName] > 0) {
            const item = document.createElement('div');
            item.className = 'inventory-item';
            item.innerHTML = `<span>üì¶ ${itemName}</span><span>${inventory[itemName]}Í∞ú</span>`;
            inventoryContent.appendChild(item);
          }
        });
      }
      
      // ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÎäî Í≤ΩÏö∞ Î©îÏãúÏßÄ ÌëúÏãú
      if (!hasItems) {
        const emptyMessage = document.createElement('div');
        emptyMessage.textContent = 'Ïù∏Î≤§ÌÜ†Î¶¨Í∞Ä ÎπÑÏñ¥ÏûàÏäµÎãàÎã§.';
        emptyMessage.style.textAlign = 'center';
        emptyMessage.style.padding = '10px';
        emptyMessage.style.color = '#888';
        inventoryContent.appendChild(emptyMessage);
      }
      
      // Î™®Îã¨ ÌëúÏãú
      inventoryModal.style.display = 'block';
    }
    
    // Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ Îã´Í∏∞ Ìï®Ïàò
    function closeInventoryModal() {
      inventoryModal.style.display = 'none';
    }
    
    // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
    window.onclick = function(event) {
      if (event.target === inventoryModal) {
        closeInventoryModal();
      }
    };

    // Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ Í¥ÄÎ†® Î≥ÄÏàò ÏÑ†Ïñ∏
    let fishTypes = [
      { name: 'ÌÉÄÏΩîÎ¨∏Ïñ¥', price: 300, material: "Î¨∏Ïñ¥Îã§Î¶¨" },
      { name: 'ÌíÄÍ≥†Îì±Ïñ¥', price: 700, material: "Í≥†Îì±Ïñ¥ÎπÑÎäò" },
      { name: 'Í≤ΩÎã®Î∂ïÏñ¥', price: 1500, material: "ÎãπÍ≥†" },
      { name: 'Î≤ÑÌÑ∞Ïò§ÏßïÏñ¥', price: 8000, material: "Î≤ÑÌÑ∞Ï°∞Í∞Å" },
      { name: 'Í∞ÑÏû•ÏÉàÏö∞', price: 15000, material: "Í∞ÑÏû•Ï¢ÖÏßÄ" },
      { name: 'Î¨ºÏàòÏàò', price: 30000, material: "Ïò•ÏàòÏàòÏΩò" },
      { name: 'Ï†ïÏñ¥Î¶¨ÌååÏù¥', price: 40000, material: "Î≤ÑÌÑ∞" },
      { name: 'ÏñºÏùåÏÉÅÏñ¥', price: 50000, material: "ÏñºÏùåÏ°∞Í∞Å" },
      { name: 'Ïä§ÌÄÑÏä§ÌÄ¥Îìú', price: 60000, material: "Ïò§ÏßïÏñ¥Î®πÎ¨º" },
      { name: 'Î∞±ÎÖÑÏÜ°Í±∞Î∂Å', price: 100000, material: "Î∞±ÎÖÑÏÜ°" },
      { name: 'Í≥†Ïä§ÌîºÏâ¨', price: 150000, material: "ÌõÑÏ∂ßÍ∞ÄÎ£®" },
      { name: 'Ïú†Î†πÏπò', price: 230000, material: "ÏÑùÌôî" },
      { name: 'Î∞îÏù¥Ìä∏ÎèÖ', price: 470000, material: "Ìï´ÏÜåÏä§" },
      { name: 'Ìò∏Î∞ïÍ≥†Îûò', price: 700000, material: "ÌéåÌÇ®Ï°∞Í∞Å" },
      { name: 'Î∞îÏù¥ÌÇπÏ°∞Í∞ú', price: 1250000, material: "ÍΩÉÏà†" },
      { name: 'Ï≤úÏÇ¨Ìï¥ÌååÎ¶¨', price: 2440000, material: "ÌîÑÎ†àÏ≤º" },
      { name: 'ÏïÖÎßàÎ≥µÏñ¥', price: 4100000, material: "Î≤†ÎÜà" },
      { name: 'Ïπ†ÏÑ±Ïû•Ïñ¥', price: 6600000, material: "Ïû•Ïñ¥Íº¨Î¶¨" },
      { name: 'Îã•ÌÑ∞Î∏îÎûô', price: 9320000, material: "ÏïÑÏù∏Ïä§Î∞îÏù∏" },
      { name: 'Ìï¥Î£°', price: 14400000, material: "Ìó§Î∏êÏ¶àÏÑúÌéÄÌä∏" },
      { name: 'Î©îÏπ¥Ìï´ÌÇπÌÅ¨Îû©', price: 27950000, material: "ÏßëÍ≤åÎã§Î¶¨" },
      { name: 'Îû®ÌîÑÎ¶¨', price: 46400000, material: "Ïù¥Ï¶àÎãàÎ≤ÑÌÑ∞" },
      { name: 'ÎßàÏßÄÎßâÏûéÏÉà', price: 76500000, material: "ÎùºÎ≤§ÎçîÏò§Ïùº" },
      { name: 'ÏïÑÏù¥Ïä§Î∏åÎ¶¨Îçî', price: 131200000, material: "ÏÉ§Î≤†Ìä∏" },
      { name: 'Ìï¥Ïã†', price: 288000000, material: "ÎßàÎ≤ïÏùòÏ†ïÏàò" },
      { name: 'ÌïëÌÇ§ÌîºÏâ¨', price: 418600000, material: "ÌúòÌïëÌÅ¨Î¶º" },
      { name: 'ÏΩòÌÜ†ÌçºÏä§', price: 731560000, material: "ÏôÄÌîåÎ¶¨Î®∏Ïã†" },
      { name: 'Îî•Ïõê', price: 1026400000, material: "Î≤†Î•¥Ï•¨Ïä§" },
      { name: 'ÌÅêÌãÄÎ£®', price: 1477500000, material: "ÏïàÏµ∏ÎπÑ" },
      { name: 'ÍΩÉÏà†ÎÇòÎ¶¨', price: 2092000000, material: "ÌïëÌÅ¨Î©úÎ°úÏö∞" },
      { name: 'Îã§Î¨¥Ïä§', price: 2633200000, material: "ÏôÄÏùºÎìúÍ∞àÎ¶≠" },
      { name: 'ÏàòÌò∏Ïûê', price: 3427900000, material: "Í∑∏Î£®ÎàÑÏïÑ" },
      { name: 'ÌÉúÏñëÍ∞ÄÏÇ¨Î¶¨', price: 6483100000, material: "ÏãúÎçîÌîåÎû≠ÌÅ¨" },
      { name: 'ÎπÖÌååÎçîÌé≠Í∑Ñ', price: 9887600000, material: "ÏÑ∏ÎπÑÏ≤¥" },
      { name: 'ÌÅ¨Î†àÏù∏ÌÑ∞ÌãÄ', price: 15124000000, material: "ÌÉÄÌååÏä§" },
      { name: 'CSP-765 Ï°∞Î¶ΩÏãùÏÉùÏÑ†', price: 19580000000, material: "Ìä∏Îü¨ÌîåÎ¶¨ÏÜåÌÜ†" },
      { name: 'Îç∞ÎìúÏºÄÏù¥ÏßÄ', price: 25420000000, material: "Ï∫êÎπÑÏïÑÏÜåÏä§" },
      { name: 'Îã§ÌÅ¨ÏïîÎ™®ÎÇòÏù¥Ìä∏', price: 31780000000, material: "Ìë∏ÏïÑÍ∑∏ÎùºÏóêÏä§Ìë∏Îßà" },
      { name: 'Ï°∞Í∞ÄÎπÑÏó¨Ïù∏', price: 38240000000, material: "ÏÉ¥ÌéòÏù∏Ï†§Î¶¨" },
      { name: '10Í∞úÌÜµÍ≥†Îûò', price: 45360000000, material: "Í∏àÎ∞ïÎßàÏπ¥Î°±" },
      { name: 'Ïä§ÌÉÄÌîºÏâ¨', price: 100, material: "Î≥ÑÏ°∞Í∞Å" }
    ];
    let catchProbabilities = [38.5, 25, 15, 8, 5, 3, 2, 1, 0.7, 0.3, 1];
    
    // Ïä§ÌÇ¨ Î†àÎ≤®Ïóê Îî∞Î•∏ ÎÇöÏùÑ Ïàò ÏûàÎäî Î¨ºÍ≥†Í∏∞ Î≤îÏúÑ Í≥ÑÏÇ∞ Ìï®Ïàò
    function getFishRangeBySkill(skillLevel) {
      let fishStartIndex = 0, fishEndIndex = 10;
      
      if (skillLevel === 2) { fishStartIndex = 1; fishEndIndex = 11; }
      else if (skillLevel === 3) { fishStartIndex = 2; fishEndIndex = 12; }
      else if (skillLevel === 4) { fishStartIndex = 3; fishEndIndex = 13; }
      else if (skillLevel === 5) { fishStartIndex = 4; fishEndIndex = 14; }
      else if (skillLevel === 6) { fishStartIndex = 5; fishEndIndex = 15; }
      else if (skillLevel === 7) { fishStartIndex = 6; fishEndIndex = 16; }
      else if (skillLevel === 8) { fishStartIndex = 7; fishEndIndex = 17; }
      else if (skillLevel === 9) { fishStartIndex = 8; fishEndIndex = 18; }
      else if (skillLevel === 10) { fishStartIndex = 9; fishEndIndex = 19; }
      else if (skillLevel === 11) { fishStartIndex = 10; fishEndIndex = 20; }
      else if (skillLevel === 12) { fishStartIndex = 11; fishEndIndex = 21; }
      else if (skillLevel === 13) { fishStartIndex = 12; fishEndIndex = 22; }
      else if (skillLevel === 14) { fishStartIndex = 13; fishEndIndex = 23; }
      else if (skillLevel === 15) { fishStartIndex = 14; fishEndIndex = 24; }
      else if (skillLevel === 16) { fishStartIndex = 15; fishEndIndex = 25; }
      else if (skillLevel === 17) { fishStartIndex = 16; fishEndIndex = 26; }
      else if (skillLevel === 18) { fishStartIndex = 17; fishEndIndex = 27; }
      else if (skillLevel === 19) { fishStartIndex = 18; fishEndIndex = 28; }
      else if (skillLevel === 20) { fishStartIndex = 19; fishEndIndex = 29; }
      else if (skillLevel === 21) { fishStartIndex = 20; fishEndIndex = 30; }
      else if (skillLevel === 22) { fishStartIndex = 21; fishEndIndex = 31; }
      else if (skillLevel === 23) { fishStartIndex = 22; fishEndIndex = 32; }
      else if (skillLevel === 24) { fishStartIndex = 23; fishEndIndex = 33; }
      else if (skillLevel === 25) { fishStartIndex = 24; fishEndIndex = 34; }
      else if (skillLevel === 26) { fishStartIndex = 25; fishEndIndex = 35; }
      else if (skillLevel === 27) { fishStartIndex = 26; fishEndIndex = 36; }
      else if (skillLevel === 28) { fishStartIndex = 27; fishEndIndex = 37; }
      else if (skillLevel === 29) { fishStartIndex = 28; fishEndIndex = 38; }
      else if (skillLevel === 30) { fishStartIndex = 29; fishEndIndex = 39; }
      else if (skillLevel >= 31) { fishStartIndex = 30; fishEndIndex = 40; }
      
      return { start: fishStartIndex, end: fishEndIndex };
    }
    
    // Î¨ºÍ≥†Í∏∞ ÌôïÎ•† Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updateFishInfoDisplay() {
      // Î©îÏù∏ ÌôîÎ©¥Ïùò currentFishInfo ÏöîÏÜå Ï∞æÍ∏∞
      const fishInfoContent = document.querySelector('#currentFishInfo');
      
      if (!fishInfoContent) {
        console.error("currentFishInfo ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. DOMÏù¥ ÏôÑÏ†ÑÌûà Î°úÎìúÎêòÏßÄ ÏïäÏïòÏùÑ Ïàò ÏûàÏäµÎãàÎã§.");
        // DOMÏù¥ Î°úÎìúÎêòÎ©¥ Îã§Ïãú ÏãúÎèÑ
        setTimeout(updateFishInfoDisplay, 500);
        return;
      }
      
      // ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤® Í∞ÄÏ†∏Ïò§Í∏∞ (Í∏∞Î≥∏Í∞í 1Î°ú ÏÑ§Ï†ï)
      const skillLevel = parseInt(localStorage.getItem('fishingSkillLevel') || '1');
      console.log("ÌòÑÏû¨ ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®:", skillLevel);
      
      // Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Î©îÏãúÏßÄ ÌëúÏãú
      if (!fishTypes || !Array.isArray(fishTypes) || fishTypes.length === 0) {
        console.error("Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÍ±∞ÎÇò Ïú†Ìö®ÌïòÏßÄ ÏïäÏäµÎãàÎã§:", fishTypes);
        fishInfoContent.innerHTML = '<div class="skill-info">Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§Îäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>';
        return;
      }
      
      console.log("Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë, Î¨ºÍ≥†Í∏∞ Ï¢ÖÎ•ò:", fishTypes.length);
      
      try {
        // Î†àÎ≤®Ïóê Îî∞Î•∏ Î¨ºÍ≥†Í∏∞ Î≤îÏúÑ Í≥ÑÏÇ∞
        const range = getFishRangeBySkill(skillLevel);
        console.log("Î¨ºÍ≥†Í∏∞ Î≤îÏúÑ:", range);
        
        // Î≤îÏúÑÍ∞Ä Î∞∞Ïó¥ Î≤îÏúÑÎ•º ÎÑòÏñ¥Í∞ÄÏßÄ ÏïäÎèÑÎ°ù Î≥¥Ï†ï
        const start = Math.min(range.start, fishTypes.length - 1);
        const end = Math.min(range.end, fishTypes.length);
        const effectiveFishTypes = fishTypes.slice(start, end);
        
        // Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞ (Ïä§ÌÉÄÌîºÏâ¨) Ï∂îÍ∞Ä
        let rareFish;
        if (fishTypes.length > 0) {
          rareFish = fishTypes[fishTypes.length - 1];
        } else {
          rareFish = { name: 'Ïä§ÌÉÄÌîºÏâ¨', price: 100, material: 'Î≥ÑÏ°∞Í∞Å' };
        }
        
        // HTML Ï¥àÍ∏∞Ìôî
        let htmlContent = '';
        
        // ÎÇöÏãú Ïä§ÌÇ¨ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        htmlContent += `
          <div class="skill-info">
            <div class="skill-level">ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®: ${skillLevel}</div>
            <div class="skill-tip">Îçî Ï¢ãÏùÄ ÎÇöÏãúÎåÄÎ°ú Î†àÎ≤®ÏóÖ!</div>
          </div>
        `;
        
        // ÏùºÎ∞ò Î¨ºÍ≥†Í∏∞ ÏÑπÏÖò
        htmlContent += `<div class="fish-info-title">üé£ ÎÇöÏãú ÌôïÎ•† Ï†ïÎ≥¥</div>`;
        htmlContent += `<div class="fish-category">üêü ÎÇöÏùÑ Ïàò ÏûàÎäî Î¨ºÍ≥†Í∏∞</div>`;
        
        // ÏùºÎ∞ò Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        if (effectiveFishTypes.length > 0) {
          for (let i = 0; i < effectiveFishTypes.length; i++) {
            const fish = effectiveFishTypes[i];
            const probability = i < catchProbabilities.length ? catchProbabilities[i] : 0;
            
            // ÌôïÎ•†Ïóê Îî∞Î•∏ Î∞î ÎÑàÎπÑ Í≥ÑÏÇ∞
            const fillWidth = Math.min(100, (probability / 40) * 100);
            
            htmlContent += `
              <div class="fish-card">
                <div class="fish-icon">üêü</div>
                <div class="fish-details">
                  <div class="fish-name">${fish.name}</div>
                  <div class="fish-stats">
                    <div class="fish-probability">
                      ÌôïÎ•†: ${probability}%
                      <div class="probability-bar">
                        <div class="probability-fill" style="width: ${fillWidth}%"></div>
                      </div>
                    </div>
                    <div class="fish-price">${formatPrice(fish.price)}Ïõê</div>
                  </div>
                </div>
              </div>
            `;
          }
        } else {
          htmlContent += `<div class="fish-card">Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>`;
        }
        
        // Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞ ÏÑπÏÖò
        htmlContent += `<div class="fish-category">‚ú® Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞</div>`;
        
        // Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        htmlContent += `
          <div class="fish-card rare-fish">
            <div class="fish-icon">‚ú®</div>
            <div class="fish-details">
              <div class="fish-name">${rareFish.name}</div>
              <div class="fish-stats">
                <div class="fish-probability">
                  ÌôïÎ•†: 0.5%
                  <div class="probability-bar">
                    <div class="probability-fill" style="width: 1.25%"></div>
                  </div>
                </div>
                <div class="fish-price">${formatPrice(rareFish.price)}Ïõê</div>
              </div>
            </div>
          </div>
        `;
        
        fishInfoContent.innerHTML = htmlContent;
        console.log("Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å!");
      } catch (error) {
        console.error("Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏ Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
        fishInfoContent.innerHTML = '<div class="skill-info">Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÌëúÏãú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.</div>';
      }
    }
    
    // Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ìï®Ïàò
    function loadFishData() {
      console.log("Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏãúÎèÑ...");
      
      // ÏÑúÎ≤ÑÏóêÏÑú Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
      fetch('/api/fish-data')
        .then(response => {
          console.log("ÏÑúÎ≤Ñ ÏùëÎãµ:", response.status);
          if (!response.ok) {
            throw new Error(`ÏÑúÎ≤Ñ Ïò§Î•ò: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ ÏàòÏã†:", data);
          if (data.success && data.fishTypes && Array.isArray(data.fishTypes) && data.fishTypes.length > 0) {
            fishTypes = data.fishTypes;
            if (data.catchProbabilities && Array.isArray(data.catchProbabilities)) {
              catchProbabilities = data.catchProbabilities;
            }
            
            // ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®Ïù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            if (!localStorage.getItem('fishingSkillLevel')) {
              localStorage.setItem('fishingSkillLevel', '1');
            }
            
            console.log("Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏÑ±Í≥µ:", fishTypes.length, "Í∞úÏùò Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ Î°úÎìúÎê®");
            updateFishInfoDisplay();
          } else {
            console.error("Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:", data.error || "Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ Îç∞Ïù¥ÌÑ∞");
            useDefaultFishData();
          }
        })
        .catch(error => {
          console.error('Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïò§Î•ò:', error);
          useDefaultFishData();
        });
    }
    
    // ÎèôÎ£å ÌòÑÌô© ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
    function updateCompanionDisplay(companions) {
      console.log("ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏...", companions);
      
      const companionStatus = document.getElementById('companionStatus');
      if (!companionStatus) {
        console.error("ÎèôÎ£å ÌòÑÌô© ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        return;
      }
      
      // Í∏∞Î≥∏ Ìó§Îçî Ï†ïÎ≥¥
      let htmlContent = `
        <div class="skill-info" style="background: linear-gradient(to right, #f3e5f5, #e1bee7);">
          <div class="skill-level" style="color: #9C27B0;">ÎèôÎ£å Ï†ïÎ≥¥</div>
          <div class="skill-tip">Ìï®ÍªòÌïòÎäî ÏπúÍµ¨Îì§</div>
        </div>
      `;
      
      // ÎèôÎ£åÍ∞Ä ÏóÜÎäî Í≤ΩÏö∞
      if (!companions || !Array.isArray(companions) || companions.length === 0) {
        htmlContent += `
          <div class="fish-card" style="text-align: center; border-left-color: #9C27B0;">
            <div style="width: 100%;">Î≥¥Ïú†Ìïú ÎèôÎ£åÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>
          </div>
        `;
      } else {
        // Í∞Å ÎèôÎ£å Ï†ïÎ≥¥ ÌëúÏãú
        companions.forEach(companion => {
          let companionEmoji = 'üë§';
          if (companion.type === 'animal') companionEmoji = 'üêæ';
          if (companion.type === 'magical') companionEmoji = '‚ú®';
          if (companion.type === 'robot') companionEmoji = 'ü§ñ';
          
          htmlContent += `
            <div class="fish-card" style="border-left-color: #9C27B0;">
              <div class="fish-icon" style="color: #9C27B0;">${companionEmoji}</div>
              <div class="fish-details">
                <div class="fish-name">${companion.name}</div>
                <div class="fish-stats">
                  <div>Î†àÎ≤®: ${companion.level || 1}</div>
                  ${companion.skill ? `<div style="margin-left: 10px;">ÌäπÍ∏∞: ${companion.skill}</div>` : ''}
                </div>
              </div>
            </div>
          `;
        });
      }
      
      companionStatus.innerHTML = htmlContent;
    }
    
    // Í∏∞Î≥∏ Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö© Ìï®Ïàò
    function useDefaultFishData() {
      console.log("Í∏∞Î≥∏ Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©");
      // Í∏∞Î≥∏ Î¨ºÍ≥†Í∏∞ Ï†ïÎ≥¥ ÏÑ§Ï†ï (Ïò§Î•ò Ïãú Í∏∞Î≥∏Í∞í)
      fishTypes = [
        { name: 'ÌÉÄÏΩîÎ¨∏Ïñ¥', price: 300, material: "Î¨∏Ïñ¥Îã§Î¶¨" },
        { name: 'ÌíÄÍ≥†Îì±Ïñ¥', price: 700, material: "Í≥†Îì±Ïñ¥ÎπÑÎäò" },
        { name: 'Í≤ΩÎã®Î∂ïÏñ¥', price: 1500, material: "ÎãπÍ≥†" },
        { name: 'Î≤ÑÌÑ∞Ïò§ÏßïÏñ¥', price: 8000, material: "Î≤ÑÌÑ∞Ï°∞Í∞Å" },
        { name: 'Í∞ÑÏû•ÏÉàÏö∞', price: 15000, material: "Í∞ÑÏû•Ï¢ÖÏßÄ" },
        { name: 'Î¨ºÏàòÏàò', price: 30000, material: "Ïò•ÏàòÏàòÏΩò" },
        { name: 'Ï†ïÏñ¥Î¶¨ÌååÏù¥', price: 40000, material: "Î≤ÑÌÑ∞" },
        { name: 'ÏñºÏùåÏÉÅÏñ¥', price: 50000, material: "ÏñºÏùåÏ°∞Í∞Å" },
        { name: 'Ïä§ÌÄÑÏä§ÌÄ¥Îìú', price: 60000, material: "Ïò§ÏßïÏñ¥Î®πÎ¨º" },
        { name: 'Î∞±ÎÖÑÏÜ°Í±∞Î∂Å', price: 100000, material: "Î∞±ÎÖÑÏÜ°" },
        { name: 'Í≥†Ïä§ÌîºÏâ¨', price: 150000, material: "ÌõÑÏ∂ßÍ∞ÄÎ£®" },
        { name: 'Ïú†Î†πÏπò', price: 230000, material: "ÏÑùÌôî" },
        { name: 'Î∞îÏù¥Ìä∏ÎèÖ', price: 470000, material: "Ìï´ÏÜåÏä§" },
        { name: 'Ìò∏Î∞ïÍ≥†Îûò', price: 700000, material: "ÌéåÌÇ®Ï°∞Í∞Å" },
        { name: 'Î∞îÏù¥ÌÇπÏ°∞Í∞ú', price: 1250000, material: "ÍΩÉÏà†" },
        { name: 'Ï≤úÏÇ¨Ìï¥ÌååÎ¶¨', price: 2440000, material: "ÌîÑÎ†àÏ≤º" },
        { name: 'ÏïÖÎßàÎ≥µÏñ¥', price: 4100000, material: "Î≤†ÎÜà" },
        { name: 'Ïπ†ÏÑ±Ïû•Ïñ¥', price: 6600000, material: "Ïû•Ïñ¥Íº¨Î¶¨" },
        { name: 'Îã•ÌÑ∞Î∏îÎûô', price: 9320000, material: "ÏïÑÏù∏Ïä§Î∞îÏù∏" },
        { name: 'Ìï¥Î£°', price: 14400000, material: "Ìó§Î∏êÏ¶àÏÑúÌéÄÌä∏" },
        { name: 'Î©îÏπ¥Ìï´ÌÇπÌÅ¨Îû©', price: 27950000, material: "ÏßëÍ≤åÎã§Î¶¨" },
        { name: 'Îû®ÌîÑÎ¶¨', price: 46400000, material: "Ïù¥Ï¶àÎãàÎ≤ÑÌÑ∞" },
        { name: 'ÎßàÏßÄÎßâÏûéÏÉà', price: 76500000, material: "ÎùºÎ≤§ÎçîÏò§Ïùº" },
        { name: 'ÏïÑÏù¥Ïä§Î∏åÎ¶¨Îçî', price: 131200000, material: "ÏÉ§Î≤†Ìä∏" },
        { name: 'Ìï¥Ïã†', price: 288000000, material: "ÎßàÎ≤ïÏùòÏ†ïÏàò" },
        { name: 'ÌïëÌÇ§ÌîºÏâ¨', price: 418600000, material: "ÌúòÌïëÌÅ¨Î¶º" },
        { name: 'ÏΩòÌÜ†ÌçºÏä§', price: 731560000, material: "ÏôÄÌîåÎ¶¨Î®∏Ïã†" },
        { name: 'Îî•Ïõê', price: 1026400000, material: "Î≤†Î•¥Ï•¨Ïä§" },
        { name: 'ÌÅêÌãÄÎ£®', price: 1477500000, material: "ÏïàÏµ∏ÎπÑ" },
        { name: 'ÍΩÉÏà†ÎÇòÎ¶¨', price: 2092000000, material: "ÌïëÌÅ¨Î©úÎ°úÏö∞" },
        { name: 'Îã§Î¨¥Ïä§', price: 2633200000, material: "ÏôÄÏùºÎìúÍ∞àÎ¶≠" },
        { name: 'ÏàòÌò∏Ïûê', price: 3427900000, material: "Í∑∏Î£®ÎàÑÏïÑ" },
        { name: 'ÌÉúÏñëÍ∞ÄÏÇ¨Î¶¨', price: 6483100000, material: "ÏãúÎçîÌîåÎû≠ÌÅ¨" },
        { name: 'ÎπÖÌååÎçîÌé≠Í∑Ñ', price: 9887600000, material: "ÏÑ∏ÎπÑÏ≤¥" },
        { name: 'ÌÅ¨Î†àÏù∏ÌÑ∞ÌãÄ', price: 15124000000, material: "ÌÉÄÌååÏä§" },
        { name: 'CSP-765 Ï°∞Î¶ΩÏãùÏÉùÏÑ†', price: 19580000000, material: "Ìä∏Îü¨ÌîåÎ¶¨ÏÜåÌÜ†" },
        { name: 'Îç∞ÎìúÏºÄÏù¥ÏßÄ', price: 25420000000, material: "Ï∫êÎπÑÏïÑÏÜåÏä§" },
        { name: 'Îã§ÌÅ¨ÏïîÎ™®ÎÇòÏù¥Ìä∏', price: 31780000000, material: "Ìë∏ÏïÑÍ∑∏ÎùºÏóêÏä§Ìë∏Îßà" },
        { name: 'Ï°∞Í∞ÄÎπÑÏó¨Ïù∏', price: 38240000000, material: "ÏÉ¥ÌéòÏù∏Ï†§Î¶¨" },
        { name: '10Í∞úÌÜµÍ≥†Îûò', price: 45360000000, material: "Í∏àÎ∞ïÎßàÏπ¥Î°±" },
        { name: 'Ïä§ÌÉÄÌîºÏâ¨', price: 100, material: "Î≥ÑÏ°∞Í∞Å" }
      ];
      
      // ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®Ïù¥ ÏÑ§Ï†ïÎêòÏßÄ ÏïäÏïòÎã§Î©¥ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
      if (!localStorage.getItem('fishingSkillLevel')) {
        localStorage.setItem('fishingSkillLevel', '1');
      }
      
      updateFishInfoDisplay();
    }
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú Î¨ºÍ≥†Í∏∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
    document.addEventListener('DOMContentLoaded', function() {
      loadFishData();
      
      // Î™®Îì† fishing-info-headerÏóê ÎåÄÌïú ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
      const infoHeaders = document.querySelectorAll('.fishing-info-header');
      
      infoHeaders.forEach(header => {
        header.addEventListener('click', function() {
          const parentWidget = this.closest('.fishing-info-widget');
          if (parentWidget) {
            parentWidget.classList.toggle('collapsed');
            
            // ÌÜ†Í∏Ä ÏïÑÏù¥ÏΩò Î∞©Ìñ• Î≥ÄÍ≤Ω (ÏòµÏÖò)
            const toggleIcon = this.querySelector('.fishing-info-toggle');
            if (toggleIcon) {
              if (parentWidget.classList.contains('collapsed')) {
                toggleIcon.textContent = '‚ñ≤';
              } else {
                toggleIcon.textContent = '‚ñº';
              }
            }
          }
        });
      });
      
      // ÏÉÅÏ†ê ÌÉ≠ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Ï∂îÍ∞Ä)
      const shopTabs = document.querySelectorAll('.shop-category');
      
      shopTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          // Î™®Îì† ÌÉ≠ÏóêÏÑú active ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
          shopTabs.forEach(t => t.classList.remove('active'));
          
          // ÌòÑÏû¨ ÌÉ≠Ïóê active ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
          this.classList.add('active');
          
          // Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê Îî∞Îùº ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú ÌïÑÌÑ∞ÎßÅ
          const category = this.getAttribute('data-category');
          filterShopItems(category);
        });
      });
      
      // Ï¥àÍ∏∞ ÌÉ≠ ÌôúÏÑ±Ìôî (ÎÇöÏãúÎåÄ)
      const initialTab = document.querySelector('.shop-category[data-category="rods"]');
      if (initialTab) {
        initialTab.classList.add('active');
        filterShopItems('rods');
      }
    });
    
    // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú ÌïÑÌÑ∞ÎßÅ Ìï®Ïàò (Ï∂îÍ∞Ä)
    function filterShopItems(category) {
      const container = document.getElementById('shop-items-container');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(shopItems).forEach(([itemName, details]) => {
        // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Îßå ÌëúÏãú
        if (details.category !== category) return;
        
        // ÏïÑÏù¥ÌÖú ÏöîÏÜå ÏÉùÏÑ±
        const itemElement = document.createElement('div');
        itemElement.className = 'shop-item';
        
        // Í∞ÄÍ≤© ÌëúÏãú ÎòêÎäî Ïû¨Î£å ÏöîÍµ¨ÏÇ¨Ìï≠ ÌëúÏãú
        let priceDisplay = '';
        if (details.price > 0) {
          priceDisplay = `${formatPrice(details.price)}Ïõê`;
        } else if (details.materialsRequired) {
          const materials = Object.entries(details.materialsRequired)
            .map(([materialName, amount]) => `${materialName} ${amount}Í∞ú`)
            .join(', ');
          priceDisplay = `ÌïÑÏöî Ïû¨Î£å: ${materials}`;
        }
        
        // HTML Íµ¨ÏÑ±
        itemElement.innerHTML = `
          <div class="shop-item-info">
            <div class="shop-item-name">${itemName}</div>
            <div class="shop-item-price">${priceDisplay}</div>
            <div class="shop-item-desc">${details.description || ''}</div>
          </div>
          <button class="buy-button" data-item="${itemName}" data-price="${details.price || 0}">Íµ¨Îß§ÌïòÍ∏∞</button>
        `;
        
        container.appendChild(itemElement);
      });
      
      // Íµ¨Îß§ Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
      setupBuyButtons();
    }

    // Ï±ÑÌåÖ Ïó∞Í≤∞ Ìï®Ïàò
    function connectToChat() {
      // Í∏∞Î≥∏ Î∞© Ïù¥Î¶Ñ
      const roomName = 'Í∏∞Î≥∏Î∞©';
      
      if (!currentUser) {
        console.error('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§. Î°úÍ∑∏Ïù∏ ÌïÑÏöî');
        return;
      }
      
      connect(currentUser.username, roomName);
    }

    // ÎèôÎ£å Î™®Ïßë Í¥ÄÎ†® Î≥ÄÏàòÏôÄ Ìï®Ïàò
    const companionTypes = [
      { id: 'sil', name: 'Ïã§', emoji: 'üë©‚Äçü¶∞', type: 'human', bonus: 'ÎÇöÏãú ÌôïÎ•† +5%', color: '#FFCDD2' },
      { id: 'fiena', name: 'ÌîºÏóêÎÇò', emoji: 'üßù‚Äç‚ôÄÔ∏è', type: 'elf', bonus: 'Î¨ºÍ≥†Í∏∞ Í∞ÄÍ≤© +10%', color: '#E1BEE7' },
      { id: 'abigail', name: 'Ïï†ÎπÑÍ≤åÏùº', emoji: 'üë©‚Äçüé§', type: 'wizard', bonus: 'Ìù¨Í∑Ä Î¨ºÍ≥†Í∏∞ ÌôïÎ•† +3%', color: '#BBDEFB' }
    ];
    
    // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎèôÎ£å Î™®Ïßë Î≤ÑÌäºÏóê Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨ Îì±Î°ù
    document.addEventListener('DOMContentLoaded', function() {
      // Í∏∞Ï°¥ ÏΩîÎìúÎäî Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ...
      
      // ÎèôÎ£å Î™®Ïßë Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Ìï∏Îì§Îü¨
      const recruitButton = document.getElementById('recruitButton');
      const recruitResult = document.getElementById('recruitResult');
      
      if (recruitButton) {
        recruitButton.addEventListener('click', function() {
          // Î°úÍ∑∏Ïù∏ Ï≤¥ÌÅ¨
          if (currentUser.isGuest) {
            recruitResult.textContent = 'ÎèôÎ£å Î™®ÏßëÏùÄ Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
            recruitResult.className = 'recruit-result recruit-fail';
            return;
          }
          
          // ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï≤¥ÌÅ¨
          if (!isConnected) {
            recruitResult.textContent = 'ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏßÄ ÏïäÏäµÎãàÎã§. Î®ºÏ†Ä Ï±ÑÌåÖÎ∞©Ïóê ÏûÖÏû•ÌïòÏÑ∏Ïöî.';
            recruitResult.className = 'recruit-result recruit-fail';
            return;
          }
          
          // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî Î∞è Ïï†ÎãàÎ©îÏù¥ÏÖò ÏãúÏûë
          recruitButton.disabled = true;
          recruitResult.textContent = 'ÎèôÎ£åÎ•º Ï∞æÎäî Ï§ë...';
          recruitResult.className = 'recruit-result recruit-animation';
          
          // ÏÑúÎ≤ÑÎ°ú ÎèôÎ£å Î™®Ïßë ÏöîÏ≤≠ Ï†ÑÏÜ°
          socket.send(JSON.stringify({
            type: 'recruitCompanion',
            userId: currentUser.uuid
          }));
        });
      }
      
      // ÎèôÎ£å Î™®Ïßë ÌÉ≠ ÌÅ¥Î¶≠ Ïãú ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
      const recruitTab = document.querySelector('.tab[data-tab="recruit"]');
      if (recruitTab) {
        recruitTab.addEventListener('click', function() {
          // ÏÇ¨Ïö©ÏûêÍ∞Ä Î°úÍ∑∏Ïù∏Ìïú ÏÉÅÌÉúÏù∏ Í≤ΩÏö∞ÏóêÎßå ÎèôÎ£å Ï†ïÎ≥¥ ÏöîÏ≤≠
          if (!currentUser.isGuest && isConnected) {
            socket.send(JSON.stringify({
              type: 'requestCompanions',
              userId: currentUser.uuid
            }));
          }
        });
      }
    });
    
    // ÏÑúÎ≤ÑÎ°úÎ∂ÄÌÑ∞ Î©îÏãúÏßÄ Ï≤òÎ¶¨ ÌôïÏû•
    socket.onmessage = (event) => {
      console.log('Î©îÏãúÏßÄ ÏàòÏã†:', event.data);
      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        data = { type: 'chat', text: event.data };
      }
      
      // Î©îÏãúÏßÄ ÌÉÄÏûÖÏóê Îî∞Î•∏ Ï≤òÎ¶¨
      if (data.type === 'join') {
        addMessage(data, 'join');
      } else if (data.type === 'leave') {
        addMessage(data, 'leave');
      } else if (data.type === 'userInfo') {
        console.log('ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÏàòÏã†:', data);
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Í∞Ä ÎπÑÏñ¥ÏûàÍ±∞ÎÇò ÏûòÎ™ªÎêú Í≤ΩÏö∞ Ï≤òÎ¶¨
        if (!data.userId) {
          console.error('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©Ïûê ID:', data);
          return;
        }
        
        // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï∞æÍ∏∞ - currentUserDataÍ∞Ä Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Ï¥àÍ∏∞Ìôî
        if (!Array.isArray(currentUserData)) {
          currentUserData = [];
        }
        
        // ÏÇ¨Ïö©Ïûê Ï∞æÍ∏∞
        const userInfo = currentUserData.find(user => user.userId === data.userId);
        let clickedUserNickname;
        
        if (userInfo) {
          clickedUserNickname = userInfo.nickname;
          console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Ï∞æÏùå: ${clickedUserNickname}`);
        } else {
          // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÎäî Í≤ΩÏö∞ ÌòÑÏû¨ ÏÇ¨Ïö©ÏûêÏù∏ÏßÄ ÌôïÏù∏
          if (data.userId === currentUser.uuid) {
            clickedUserNickname = currentUser.username || 'Î≥∏Ïù∏';
            console.log(`ÌòÑÏû¨ ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥: ${clickedUserNickname}`);
          } else {
            clickedUserNickname = 'Ïïå Ïàò ÏóÜÏùå';
            console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏùå, userId: ${data.userId}`);
          }
        }
        
        console.log(`ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ ÌëúÏãú: ${clickedUserNickname}, Ïù∏Î≤§ÌÜ†Î¶¨: `, data.inventory);
        console.log(`ÏÇ¨Ïö©Ïûê Í≥®Îìú: ${data.gold}, Ïä§ÌÇ¨ Î†àÎ≤®: ${data.skillLevel}`);
        
        // Î≥∏Ïù∏ Ï†ïÎ≥¥Ïù∏ Í≤ΩÏö∞ Ïä§ÌÇ¨ Î†àÎ≤® ÏóÖÎç∞Ïù¥Ìä∏
        if (data.userId === currentUser.uuid && data.skillLevel !== undefined) {
          localStorage.setItem('fishingSkillLevel', data.skillLevel.toString());
          console.log(`ÏÑúÎ≤ÑÏóêÏÑú Î∞õÏùÄ ÎÇöÏãú Ïä§ÌÇ¨ Î†àÎ≤®(${data.skillLevel})ÏùÑ Ï†ÄÏû•ÌñàÏäµÎãàÎã§.`);
          // ÎÇöÏãú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
          updateFishInfoDisplay();
          
          // ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
          if (data.companions) {
            updateCompanionDisplay(data.companions);
          }
        }
        
        // ÏûêÎèô ÏöîÏ≤≠Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Ïù∏Î≤§ÌÜ†Î¶¨ Î™®Îã¨ ÌëúÏãú
        if (inventoryModalRequested && !data.autoRequest) {
          showInventoryModal(
            clickedUserNickname,
            data.inventory || {},
            data.gold || 0,
            data.skillLevel || 1
          );
          // ÏöîÏ≤≠ ÌîåÎûòÍ∑∏ Ï¥àÍ∏∞Ìôî
          inventoryModalRequested = false;
        }
      } else if (data.type === 'user_list') {
        // Í∏∞Ï°¥ ÏÇ¨Ïö©Ïûê Î™©Î°ùÏùÑ Ï≤òÎ¶¨
        currentUserData = data.users;
        console.log('ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏:', currentUserData);
        updateUserList();
      } else if (data.type === 'full_user_list') {
        // Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Î™©Î°ùÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
        currentUserData = data.users;
        console.log('Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏:', currentUserData);
        updateUserList();
      } else if (data.type === 'recruitResult') {
        // ÎèôÎ£å Î™®Ïßë Í≤∞Í≥º Ï≤òÎ¶¨
        const recruitButton = document.getElementById('recruitButton');
        const recruitResult = document.getElementById('recruitResult');
        
        // Î≤ÑÌäº ÌôúÏÑ±Ìôî
        if (recruitButton) recruitButton.disabled = false;
        
        if (data.success) {
          // ÏÑ±Í≥µ Ïãú Ï≤òÎ¶¨
          const companion = data.companion;
          let companionEmoji = 'üë§';
          let companionColor = '#673AB7';
          
          // Ìï¥Îãπ ÎèôÎ£å Ï∞æÍ∏∞
          const companionType = companionTypes.find(type => type.id === companion.id);
          if (companionType) {
            companionEmoji = companionType.emoji;
            companionColor = companionType.color;
          }
          
          // Í≤∞Í≥º Î©îÏãúÏßÄ ÌëúÏãú
          recruitResult.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
              <span style="font-size: 2em;">${companionEmoji}</span>
              <div>
                <div style="font-size: 1.2em; color: ${companionColor};">${companion.name} ÎèôÎ£å ÌöçÎìù!</div>
                <div style="font-size: 0.9em; color: #555;">${companion.bonus}</div>
              </div>
            </div>
          `;
          recruitResult.className = 'recruit-result recruit-success';
          
          // ÎèôÎ£å Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
          if (data.companions) {
            updateCompanionDisplay(data.companions);
          }
          
          // ÏÑ±Í≥µ Î©îÏãúÏßÄ Ï±ÑÌåÖÏ∞ΩÏóê ÌëúÏãú
          addMessage(`üéâ Ï∂ïÌïòÌï©ÎãàÎã§! ${companion.name} ÎèôÎ£åÎ•º ÏñªÏóàÏäµÎãàÎã§!`);
        } else {
          // Ïã§Ìå® Ïãú Ï≤òÎ¶¨
          if (data.error === 'no_star_fragment') {
            recruitResult.textContent = 'Î≥ÑÏ°∞Í∞ÅÏù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§. Î≥ÑÏ°∞Í∞ÅÏùÑ ÏñªÏùÄ ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
          } else if (data.error === 'already_has_companion') {
            recruitResult.textContent = 'Ïù¥ÎØ∏ Î≥¥Ïú†Ìïú ÎèôÎ£åÏûÖÎãàÎã§. Îã§Î•∏ ÎèôÎ£åÎ•º ÎΩëÏùÑ ÌôïÎ•†Ïù¥ ÎÜíÏïÑÏßëÎãàÎã§!';
          } else if (data.error === 'not_authenticated') {
            recruitResult.textContent = 'Î°úÍ∑∏Ïù∏ ÌõÑ Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.';
          } else {
            recruitResult.textContent = 'ÎèôÎ£å Î™®ÏßëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.';
          }
          recruitResult.className = 'recruit-result recruit-fail';
        }
      } else if (data.type === 'companions') {
        // ÎèôÎ£å Î™©Î°ù ÏóÖÎç∞Ïù¥Ìä∏
        if (data.companions) {
          updateCompanionDisplay(data.companions);
        }
      } else {
        addMessage(data);
      }
    };
  </script>
</body>
</html>
