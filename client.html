<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>🎣 낚시 채팅방</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 20px;
      max-width: 1000px;
      margin: auto;
      display: flex;
      flex-direction: row;
      gap: 20px;
    }
    .chat-container {
      flex: 1;
    }
    .user-list-container {
      width: 200px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      height: fit-content;
    }
    .user-list-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #4a90e2;
      text-align: center;
    }
    .user-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .user-item {
      padding: 5px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .user-item:last-child {
      border-bottom: none;
    }
    .user-item:hover {
      background-color: #f5f5f5;
    }
    h1 {
      color: #4a90e2;
      text-align: center;
    }
    #status {
      margin-bottom: 10px;
      font-weight: bold;
    }
    #messages {
      height: 300px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      white-space: pre-line;
    }
    #messageForm {
      display: flex;
      gap: 5px;
    }
    #messageInput {
      flex: 1;
      padding: 10px;
      font-size: 14px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      background: #4a90e2;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background: #357ab7;
    }
    #controls {
      margin-bottom: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    #controls label {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    #controls input {
      flex: 1;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .userNickname {
      color: #4a90e2;
      cursor: pointer;
      text-decoration: underline;
    }
    /* 상점 스타일 */
    .shop-container {
      margin-top: 20px;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
    }
    .shop-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #4a90e2;
      text-align: center;
    }
    .shop-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    .shop-item:last-child {
      border-bottom: none;
    }
    .shop-item-info {
      flex: 1;
    }
    .shop-item-name {
      font-weight: bold;
    }
    .shop-item-price {
      color: #4a90e2;
    }
    .shop-item-desc {
      font-size: 0.9em;
      color: #666;
    }
    .tabs {
      display: flex;
      margin-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
    .tab {
      padding: 8px 16px;
      cursor: pointer;
      background: #f1f1f1;
      border: 1px solid #ccc;
      border-bottom: none;
      border-radius: 5px 5px 0 0;
      margin-right: 5px;
    }
    .tab.active {
      background: #fff;
      border-bottom: 1px solid #fff;
      margin-bottom: -1px;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    /* 로그인 및 회원가입 폼 스타일 */
    .auth-container {
      max-width: 400px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .auth-form input {
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .auth-form button {
      margin-top: 10px;
    }
    .auth-toggle {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }
    .auth-toggle a {
      color: #4a90e2;
      text-decoration: none;
      cursor: pointer;
    }
    .auth-toggle a:hover {
      text-decoration: underline;
    }
    .auth-message {
      padding: 10px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }
    .auth-message.error {
      background: #ffebee;
      color: #d32f2f;
      display: block;
    }
    .auth-message.success {
      background: #e8f5e9;
      color: #388e3c;
      display: block;
    }
    .user-info {
      background: #f1f8e9;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .user-info-text {
      font-weight: bold;
    }
    #logoutBtn {
      padding: 5px 10px;
      font-size: 12px;
    }
    #authContainer {
      display: block;
    }
    #chatContainer {
      display: none;
    }
    /* 모달 스타일 추가 */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 500px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    .close-modal {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-modal:hover {
      color: #555;
    }
    .inventory-list {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .inventory-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 0;
      border-bottom: 1px solid #f5f5f5;
    }
    .modal-title {
      color: #4a90e2;
      margin-top: 0;
      font-size: 1.2em;
    }
    /* Fish 이모티콘 추가 */
    .fish-emoji {
      margin-right: 5px;
    }
    
    .gold-amount {
      color: #f8c537;
      font-weight: bold;
    }
    .inventory-skill {
      padding: 10px;
      background-color: #e8f5e9;
      border-radius: 5px;
      margin-bottom: 10px;
    }
    .skill-info {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .skill-description {
      font-size: 0.9em;
      color: #388e3c;
    }
    .accessory-effect {
      display: block;
      font-size: 0.9em;
      color: #5c6bc0;
      margin-top: 5px;
    }
    .inventory-item.equipped {
      background-color: #e3f2fd;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 8px;
    }
    .item-actions {
      margin-top: 5px;
    }
    .store-section {
      margin-bottom: 20px;
    }
    .store-section h3 {
      margin-bottom: 10px;
      color: #2c3e50;
      border-bottom: 1px solid #ecf0f1;
      padding-bottom: 5px;
    }
    .store-item {
      display: flex;
      flex-direction: column;
      padding: 10px;
      margin-bottom: 6px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }
    .item-effect {
      font-size: 0.85em;
      color: #3498db;
      margin: 3px 0;
    }
    .item-details {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 5px;
    }
    .price {
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- 인증 컨테이너 -->
  <div id="authContainer" class="auth-container">
    <h1>🎣 낚시 채팅방</h1>
    
    <!-- 로그인 폼 -->
    <div id="loginForm" class="auth-form">
      <h2>로그인</h2>
      <input type="text" id="loginUsername" placeholder="사용자 이름" required>
      <input type="password" id="loginPassword" placeholder="비밀번호" required>
      <button id="loginBtn">로그인</button>
      <div id="loginMessage" class="auth-message"></div>
      <div class="auth-toggle">
        계정이 없으신가요? <a id="showRegisterBtn">회원가입</a>
      </div>
      <div class="auth-toggle">
        <a id="guestLoginBtn">게스트로 입장하기</a>
      </div>
    </div>
    
    <!-- 회원가입 폼 -->
    <div id="registerForm" class="auth-form" style="display: none;">
      <h2>회원가입</h2>
      <input type="text" id="registerUsername" placeholder="사용자 이름" required>
      <input type="password" id="registerPassword" placeholder="비밀번호" required>
      <input type="password" id="confirmPassword" placeholder="비밀번호 확인" required>
      <button id="registerBtn">회원가입</button>
      <div id="registerMessage" class="auth-message"></div>
      <div class="auth-toggle">
        이미 계정이 있으신가요? <a id="showLoginBtn">로그인</a>
      </div>
    </div>
  </div>

  <!-- 채팅 컨테이너 -->
  <div id="chatContainer" style="width: 100%; display: flex;">
    <div class="chat-container">
      <h1>🎣 낚시 채팅방</h1>
      
      <div id="userInfo" class="user-info">
        <span id="userInfoText" class="user-info-text">게스트로 로그인됨</span>
        <button id="logoutBtn">로그아웃</button>
      </div>
      
      <div id="status">서버 연결 상태: <span style="color:red;">연결 중...</span></div>
      
      <div id="controls">
        <label>방 이름: <input id="roomInput" value="기본방" /></label>
        <button id="joinButton">입장</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="chat">💬 채팅</div>
        <div class="tab" data-tab="shop">🛒 상점</div>
      </div>

      <div id="chatTab" class="tab-content active">
        <div id="messages"></div>

        <form id="messageForm" style="display:none;">
          <input type="text" id="messageInput" placeholder="명령어나 메시지 입력..." />
          <button type="submit">전송</button>
        </form>
      </div>

      <div id="shopTab" class="tab-content">
        <div class="shop-container">
          <div class="shop-title">🛒 낚시 용품 상점</div>
          <div id="storeList">
            <!-- 상점 아이템이 여기에 동적으로 표시됩니다 -->
          </div>
        </div>
      </div>
    </div>

    <div class="user-list-container">
      <div class="user-list-title">👥 참여자 목록 (<span id="userCount">0</span>명)</div>
      <ul id="userList" class="user-list">
        <!-- 참여자 목록이 여기에 동적으로 추가됩니다 -->
      </ul>
    </div>
  </div>

  <!-- 인벤토리 모달 추가 -->
  <div id="inventoryModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeInventoryModal()">&times;</span>
      <h3 class="modal-title" id="modalTitle">사용자 인벤토리</h3>
      <div id="inventoryItems" class="inventory-list">
        <!-- 인벤토리 항목들이 여기에 동적으로 추가됨 -->
      </div>
    </div>
  </div>

  <script>
    // DOM 요소 참조
    const authContainer = document.getElementById('authContainer');
    const chatContainer = document.getElementById('chatContainer');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginUsername = document.getElementById('loginUsername');
    const loginPassword = document.getElementById('loginPassword');
    const registerUsername = document.getElementById('registerUsername');
    const registerPassword = document.getElementById('registerPassword');
    const confirmPassword = document.getElementById('confirmPassword');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const showRegisterBtn = document.getElementById('showRegisterBtn');
    const showLoginBtn = document.getElementById('showLoginBtn');
    const guestLoginBtn = document.getElementById('guestLoginBtn');
    const loginMessage = document.getElementById('loginMessage');
    const registerMessage = document.getElementById('registerMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfoText = document.getElementById('userInfoText');
    
    const statusText = document.getElementById('status');
    const messages = document.getElementById('messages');
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');
    const roomInput = document.getElementById('roomInput');
    const joinBtn = document.getElementById('joinButton');
    const userList = document.getElementById('userList');
    const userCountElement = document.getElementById('userCount');
    const buyFishingRodBtn = document.getElementById('buyFishingRod');
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    let socket;
    let currentUsers = new Set();
    let isConnected = false;
    let currentUser = {
      uuid: null,
      username: null,
      isGuest: true
    };

    const inventoryModal = document.getElementById('inventoryModal');
    const modalTitle = document.getElementById('modalTitle');
    const inventoryContent = document.getElementById('inventoryContent');
    let currentUserData = [];

    const accessoryNames = ['없음', '오래된반지', '은목걸이', '금귀걸이', '마법의펜던트', '에메랄드브로치', '토파즈이어링', '자수정팔찌', '백금티아라', '만드라고라허브', '에테르나무묘목', '몽마의조각상', '마카롱훈장', '빛나는마력순환체'];
    const rodNames = ['맨손', '낡은낚시대', '일반낚시대', '단단한낚시대', '은낚시대', '금낚시대', '강철낚시대', '사파이어낚시대', '루비낚시대', '다이아몬드낚시대', '레드다이아몬드낚시대', '벚꽃낚시대', '꽃망울낚시대', '호롱불낚시대', '산호등낚시대', '피크닉', '마녀빗자루', '에테르낚시대', '별조각낚시대', '여우꼬리낚시대', '초콜릿롤낚시대', '호박유령낚시대', '핑크버니낚시대', '할로우낚시대', '여우불낚시대'];
    const fishNames = [];
    
    // 사용자 데이터 저장 변수들
    let userInventory = {};    // 사용자 인벤토리
    let userGold = 0;          // 사용자 골드
    let fishingCooldown = 0;   // 낚시 쿨다운

    // 로컬스토리지에서 사용자 정보 불러오기
    function loadUserFromStorage() {
      const savedUser = localStorage.getItem('currentUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        
        // 사용자 정보 표시
        if (currentUser.isGuest) {
          userInfoText.textContent = "게스트로 로그인됨";
        } else {
          userInfoText.textContent = `${currentUser.username}으로 로그인됨 (UUID: ${currentUser.uuid.substring(0, 8)}...)`;
        }
        
        // 채팅 화면 보이기
        authContainer.style.display = 'none';
        chatContainer.style.display = 'flex';
      }
    }

    // 초기화 시 로컬스토리지 확인
    loadUserFromStorage();

    // 폼 전환 이벤트 리스너
    showRegisterBtn.addEventListener('click', () => {
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
      loginMessage.textContent = '';
      loginMessage.className = 'auth-message';
    });

    showLoginBtn.addEventListener('click', () => {
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
      registerMessage.textContent = '';
      registerMessage.className = 'auth-message';
    });

    // 게스트 로그인
    guestLoginBtn.addEventListener('click', () => {
      currentUser = {
        uuid: null,
        username: null,
        isGuest: true
      };
      
      // 로컬스토리지에 저장
      localStorage.setItem('currentUser', JSON.stringify(currentUser));
      
      // 화면 전환
      authContainer.style.display = 'none';
      chatContainer.style.display = 'flex';
      userInfoText.textContent = "게스트로 로그인됨";
    });

    // 로그아웃 기능
    logoutBtn.addEventListener('click', () => {
      // 소켓 연결 종료
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        socket.close();
      }
      
      // 사용자 정보 초기화
      currentUser = {
        uuid: null,
        username: null,
        isGuest: true
      };
      
      // 로컬스토리지에서 제거
      localStorage.removeItem('currentUser');
      
      // 화면 초기화
      messages.innerHTML = '';
      currentUsers.clear();
      updateUserList();
      form.style.display = 'none';
      
      // 로그인 화면으로 전환
      chatContainer.style.display = 'none';
      authContainer.style.display = 'block';
      loginForm.style.display = 'block';
      registerForm.style.display = 'none';
    });

    // 회원가입 기능
    registerBtn.addEventListener('click', async () => {
      const username = registerUsername.value.trim();
      const password = registerPassword.value;
      const confirmPwd = confirmPassword.value;
      
      // 입력 검증
      if (!username || !password) {
        registerMessage.textContent = '사용자 이름과 비밀번호를 모두 입력해주세요.';
        registerMessage.className = 'auth-message error';
        return;
      }
      
      if (password !== confirmPwd) {
        registerMessage.textContent = '비밀번호가 일치하지 않습니다.';
        registerMessage.className = 'auth-message error';
        return;
      }
      
      try {
        const response = await fetch('/api/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          registerMessage.textContent = data.message;
          registerMessage.className = 'auth-message success';
          
          // 3초 후 로그인 폼으로 전환
          setTimeout(() => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            loginUsername.value = username;
            registerMessage.textContent = '';
            registerMessage.className = 'auth-message';
          }, 3000);
        } else {
          registerMessage.textContent = data.message;
          registerMessage.className = 'auth-message error';
        }
      } catch (error) {
        registerMessage.textContent = '서버 오류가 발생했습니다. 다시 시도해주세요.';
        registerMessage.className = 'auth-message error';
      }
    });

    // 로그인 기능
    loginBtn.addEventListener('click', async () => {
      const username = loginUsername.value.trim();
      const password = loginPassword.value;
      
      // 입력 검증
      if (!username || !password) {
        loginMessage.textContent = '사용자 이름과 비밀번호를 모두 입력해주세요.';
        loginMessage.className = 'auth-message error';
        return;
      }
      
      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username, password }),
        });
        
        const data = await response.json();
        
        if (response.ok) {
          loginMessage.textContent = data.message;
          loginMessage.className = 'auth-message success';
          
          // 사용자 정보 저장
          currentUser = {
            uuid: data.uuid,
            username: data.username,
            isGuest: false
          };
          
          // 로컬스토리지에 저장
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          
          // 사용자 정보 표시
          userInfoText.textContent = `${currentUser.username}으로 로그인됨 (UUID: ${currentUser.uuid.substring(0, 8)}...)`;
          
          // 화면 전환
          setTimeout(() => {
            authContainer.style.display = 'none';
            chatContainer.style.display = 'flex';
            loginMessage.textContent = '';
            loginMessage.className = 'auth-message';
          }, 1500);
        } else {
          loginMessage.textContent = data.message;
          loginMessage.className = 'auth-message error';
        }
      } catch (error) {
        loginMessage.textContent = '서버 오류가 발생했습니다. 다시 시도해주세요.';
        loginMessage.className = 'auth-message error';
      }
    });

    // 탭 전환 기능
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        // 활성 탭 변경
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // 활성 콘텐츠 변경
        const tabId = tab.getAttribute('data-tab');
        tabContents.forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(tabId + 'Tab').classList.add('active');
        
        // 상점 탭이 활성화되면 상점 리스트 업데이트
        if (tabId === 'shop') {
          updateStoreList();
        }
      });
    });

    // 낡은 낚싯대 구매 기능
    buyFishingRodBtn.addEventListener('click', () => {
      if (!isConnected) {
        alert('서버에 연결되어 있지 않습니다. 먼저 채팅방에 입장하세요.');
        return;
      }
      
      socket.send(JSON.stringify({ 
        type: 'buy', 
        item: '낡은낚시대',
        price: 100 
      }));
    });

    function updateUserList() {
      const userListElement = document.getElementById('userList');
      userListElement.innerHTML = '';
      
      currentUserData.forEach(user => {
        const listItem = document.createElement('li');
        listItem.className = 'user-item';
        listItem.textContent = user.nickname;
        
        // 닉네임 클릭 이벤트 추가
        listItem.addEventListener('click', () => {
          if (user.userId) {
            requestUserInventory(user.userId, user.nickname);
          } else {
            alert('사용자 정보를 가져올 수 없습니다.');
          }
        });
        
        userListElement.appendChild(listItem);
      });
      
      userCountElement.textContent = currentUserData.length;
    }

    // 초기 목록 업데이트
    updateUserList();

    function addMessage(msg, type = 'chat') {
      if (type === 'join' && msg.userId && msg.nickname) {
        // join 메시지: 닉네임을 클릭 가능하도록 표시
        const div = document.createElement('div');
        const timeMatch = msg.text.match(/^\[.*?\]/);
        const timeStr = timeMatch ? timeMatch[0] : '';
        const prefix = " 💬 ";
        const suffix = "님이 입장했습니다.";
        div.innerHTML = `${timeStr}${prefix}<span class="userNickname" data-userid="${msg.userId}">${msg.nickname}</span>${suffix}`;
        div.querySelector('.userNickname').onclick = function () {
          const targetUserId = this.getAttribute('data-userid');
          socket.send(JSON.stringify({ type: 'requestUserInfo', targetUserId }));
        };
        messages.appendChild(div);
      } else if (type === 'leave' && msg.nickname) {
        // 퇴장 메시지 표시
        const div = document.createElement('div');
        div.textContent = msg.text;
        messages.appendChild(div);
      } else {
        const div = document.createElement('div');
        div.textContent = typeof msg === 'string' ? msg : msg.text;
        messages.appendChild(div);
      }
      messages.scrollTop = messages.scrollHeight;
    }

    // 연결 함수
    function connect(nickname, room) {
      // 현재 호스트 기반으로 WebSocket URL 생성
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const host = window.location.host;
      const url = `${protocol}//${host}`;
      console.log("연결 시도:", url);
      
      socket = new WebSocket(url);
      
      socket.addEventListener('open', function(event) {
        console.log("WebSocket 연결 성공!");
        // UUID가 있으면 함께 전송
        socket.send(JSON.stringify({ 
          type: 'join', 
          nickname, 
          room,
          uuid: currentUser.uuid 
        }));
        
        statusText.innerHTML = '서버 연결 상태: <span style="color:green;">연결됨</span>';
        form.style.display = 'flex';
        input.focus();
        isConnected = true;
      });

      socket.addEventListener('error', function(event) {
        console.error("WebSocket 오류 발생:", event);
        statusText.innerHTML = '서버 연결 상태: <span style="color:red;">연결 오류</span>';
        isConnected = false;
        alert('서버 연결에 실패했습니다. 페이지를 새로고침 하거나 나중에 다시 시도해주세요.');
      });

      socket.onmessage = (event) => {
        let data;
        try {
          data = JSON.parse(event.data);
        } catch (e) {
          data = { type: 'chat', text: event.data };
        }
        if (data.type === 'join') {
          addMessage(data, 'join');
        } else if (data.type === 'leave') {
          addMessage(data, 'leave');
        } else if (data.type === 'userInfo') {
          // 인벤토리 정보 모달로 표시
          showInventoryModal(
            currentUserData.find(user => user.userId === data.userId)?.nickname || '알 수 없음',
            data.inventory || {},
            data.gold || 0,
            data.fishingSkill || 0
          );
        } else if (data.type === 'myInfo') {
          // 나의 정보 업데이트
          userInventory = data.inventory || {};
          userGold = data.gold || 0;
          currentUserData.fishingSkill = data.fishingSkill || 0;
          document.getElementById('goldAmount').textContent = userGold;
          updateInventoryDisplay();
        } else if (data.type === 'user_list') {
          // 기존 사용자 목록을 처리
          currentUserData = data.users;
          updateUserList();
        } else if (data.type === 'full_user_list') {
          // 전체 사용자 목록으로 업데이트
          currentUserData = data.users;
          updateUserList();
        } else {
          addMessage(data);
        }
      };

      socket.onclose = () => {
        statusText.innerHTML = '서버 연결 상태: <span style="color:red;">연결 종료</span>';
        addMessage('❌ 서버 연결 종료됨');
        form.style.display = 'none';
        currentUsers.clear();
        updateUserList();
        isConnected = false;
      };

      form.onsubmit = (e) => {
        e.preventDefault();
        if (!input.value.trim()) return;
        socket.send(JSON.stringify({ type: 'message', text: input.value.trim() }));
        input.value = '';
      };
    }

    joinBtn.onclick = () => {
      const room = roomInput.value.trim() || '기본방';
      
      // 닉네임 설정 (로그인된 사용자는 사용자 이름, 게스트는 임의 이름)
      let nickname;
      if (!currentUser.isGuest && currentUser.username) {
        nickname = currentUser.username;
      } else {
        nickname = 'Guest_' + Math.floor(Math.random() * 10000);
      }

      // 기존 연결이 있으면 닫기
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        socket.close();
      }

      connect(nickname, room);
    };

    // 인벤토리 모달 표시 함수
    function showInventoryModal(nickname, inventory, gold, fishingSkill) {
      // 현재 사용자 데이터 업데이트
      currentUserData = {
        nickname: nickname,
        inventory: inventory,
        gold: gold,
        fishingSkill: fishingSkill
      };
      
      // 타이틀 설정
      modalTitle.textContent = `${nickname}의 인벤토리`;
      
      // 인벤토리 표시 업데이트
      userInventory = inventory;
      userGold = gold;
      updateInventoryDisplay();
      
      // 모달 표시
      inventoryModal.style.display = 'block';
    }
    
    // 사용자 인벤토리 요청 함수
    function requestUserInventory(userId, nickname) {
      if (!isConnected) {
        alert('서버에 연결되어 있지 않습니다.');
        return;
      }
      
      socket.send(JSON.stringify({ 
        type: 'requestUserInfo', 
        targetUserId: userId 
      }));
    }
    
    // 인벤토리 모달 닫기 함수
    function closeInventoryModal() {
      inventoryModal.style.display = 'none';
    }
    
    // 낚시 쿨다운 시간을 악세서리에 따라 계산하는 함수
    function calculateCooldownTime(accessory) {
      switch(accessory) {
        case "오래된반지": return 285000; // 4분 45초
        case "은목걸이": return 270000; // 4분 30초
        case "금귀걸이": return 255000; // 4분 15초
        case "마법의펜던트": return 240000; // 4분
        case "에메랄드브로치": return 225000; // 3분 45초
        case "토파즈이어링": return 210000; // 3분 30초
        case "자수정팔찌": return 195000; // 3분 15초
        case "백금티아라": return 180000; // 3분
        case "만드라고라허브": return 165000; // 2분 45초
        case "에테르나무묘목": return 150000; // 2분 30초
        case "몽마의조각상": return 135000; // 2분 15초
        case "마카롱훈장": return 120000; // 2분
        case "빛나는마력순환체": return 90000; // 1분 30초
        default: return 300000; // 5분
      }
    }
    
    // 낚시 스킬 레벨에 따른 물고기 범위 설명을 반환하는 함수
    function getFishingSkillDescription(skillLevel) {
      if (skillLevel <= 1) {
        return "초보자 레벨: 기본 물고기만 낚을 수 있습니다. (더 높은 레벨의 낚시대 구매 시 스킬 상승)";
      } else if (skillLevel === 2) {
        return "입문자 레벨: 약간 더 좋은 물고기를 낚을 수 있습니다. (더 높은 레벨의 낚시대 구매 시 스킬 상승)";
      } else if (skillLevel >= 3 && skillLevel <= 10) {
        return "중급자 레벨: 중간 등급의 물고기를 낚을 수 있습니다. (더 높은 레벨의 낚시대 구매 시 스킬 상승)";
      } else if (skillLevel >= 11 && skillLevel <= 20) {
        return "고급자 레벨: 희귀한 물고기를 낚을 가능성이 있습니다. (더 높은 레벨의 낚시대 구매 시 스킬 상승)";
      } else if (skillLevel >= 21 && skillLevel <= 26) {
        return "전문가 레벨: 매우 희귀한 물고기를 낚을 확률이 있습니다. (더 높은 레벨의 낚시대 구매 시 스킬 상승)";
      } else {
        return "마스터 레벨: 전설급 물고기를 낚을 수 있습니다! (최고 레벨)";
      }
    }
    
    // 인벤토리 표시 업데이트
    function updateInventoryDisplay() {
      const inventoryContainer = document.getElementById('inventoryItems');
      inventoryContainer.innerHTML = '';
      
      // 낚시 스킬 표시
      if (currentUserData.fishingSkill !== undefined) {
        const skillElement = document.createElement('div');
        skillElement.className = 'inventory-skill';
        
        // 낚시 스킬 설명 추가
        const skillDescription = getFishingSkillDescription(currentUserData.fishingSkill);
        
        skillElement.innerHTML = `
          <div class="skill-info">
            <span>🔱 낚시 스킬: ${currentUserData.fishingSkill} 레벨</span>
            <span class="skill-description">${skillDescription}</span>
          </div>
        `;
        inventoryContainer.appendChild(skillElement);
      }
      
      // 장착된 낚싯대 확인 및 표시
      let equippedRod = null;
      for (const rod of rodNames) {
        if (userInventory[`장착된 ${rod}`]) {
          equippedRod = rod;
          const rodElement = document.createElement('div');
          rodElement.className = 'inventory-item equipped';
          rodElement.innerHTML = `
            <span>🎣 ${rod} (장착됨)</span>
            <div class="item-actions">
              <button class="unequip-btn" data-item="${rod}">해제</button>
            </div>
          `;
          inventoryContainer.appendChild(rodElement);
          break;
        }
      }
      
      // 장착된 액세서리 확인 및 표시
      let equippedAccessory = null;
      for (const accessory of accessoryNames) {
        if (userInventory[`장착된 ${accessory}`]) {
          equippedAccessory = accessory;
          const accessoryElement = document.createElement('div');
          accessoryElement.className = 'inventory-item equipped';
          
          // 쿨다운 시간 계산
          const cooldownTime = calculateCooldownTime(accessory);
          const cooldownMinutes = Math.floor(cooldownTime / 60000);
          const cooldownSeconds = Math.floor((cooldownTime % 60000) / 1000);
          
          // 판매 보너스 계산
          let bonusPercent = 0;
          switch(accessory) {
            case "오래된반지": bonusPercent = 5; break;
            case "은목걸이": bonusPercent = 10; break;
            case "금귀걸이": bonusPercent = 15; break;
            case "마법의펜던트": bonusPercent = 20; break;
            case "에메랄드브로치": bonusPercent = 25; break;
            case "토파즈이어링": bonusPercent = 30; break;
            case "자수정팔찌": bonusPercent = 35; break;
            case "백금티아라": bonusPercent = 40; break;
            case "만드라고라허브": bonusPercent = 45; break;
            case "에테르나무묘목": bonusPercent = 50; break;
            case "몽마의조각상": bonusPercent = 55; break;
            case "마카롱훈장": bonusPercent = 60; break;
            case "빛나는마력순환체": bonusPercent = 80; break;
            default: bonusPercent = 0; break;
          }
          
          accessoryElement.innerHTML = `
            <span>💍 ${accessory} (장착됨)</span>
            <span class="accessory-effect">낚시 쿨다운: ${cooldownMinutes}분 ${cooldownSeconds}초</span>
            <span class="accessory-effect">판매 보너스: +${bonusPercent}%</span>
            <div class="item-actions">
              <button class="unequip-btn" data-item="${accessory}">해제</button>
            </div>
          `;
          inventoryContainer.appendChild(accessoryElement);
          break;
        }
      }
      
      // 나머지 인벤토리 아이템 표시
      for (const item in userInventory) {
        // 이미 장착된 아이템은 다시 표시하지 않음
        if (item.startsWith('장착된 ')) continue;
        if ((equippedRod === item && userInventory[item] === 0) || 
            (equippedAccessory === item && userInventory[item] === 0)) continue;
        
        if (userInventory[item] > 0) {
          const itemElement = document.createElement('div');
          itemElement.className = 'inventory-item';
          
          // 아이템 종류에 따른 아이콘 추가 및 버튼 설정
          let itemIcon = '📦';
          let itemActions = '';
          
          if (rodNames.includes(item)) {
            itemIcon = '🎣';
            if (!equippedRod) {
              itemActions = `<button class="equip-btn" data-item="${item}">장착</button>`;
            }
          } else if (accessoryNames.includes(item)) {
            itemIcon = '💍';
            if (!equippedAccessory) {
              itemActions = `<button class="equip-btn" data-item="${item}">장착</button>`;
            }
          } else if (item !== '맨손' && item !== '없음' && !item.startsWith('장착된') && !rodNames.includes(item) && !accessoryNames.includes(item)) {
            // 낚시대와 악세서리가 아닌 아이템은 모두 물고기로 간주하고 판매 버튼 추가
            itemIcon = '🐟';
            itemActions = `<button class="sell-btn" data-item="${item}">판매</button>`;
          }
          
          itemElement.innerHTML = `
            <span>${itemIcon} ${item} (${userInventory[item]}개)</span>
            <div class="item-actions">
              ${itemActions}
            </div>
          `;
          inventoryContainer.appendChild(itemElement);
        }
      }
      
      // 인벤토리가 비어있는 경우
      if (inventoryContainer.children.length === 0) {
        const emptyMessage = document.createElement('div');
        emptyMessage.className = 'empty-inventory';
        emptyMessage.textContent = '인벤토리가 비었습니다.';
        inventoryContainer.appendChild(emptyMessage);
      }
      
      // 장착 버튼 이벤트 리스너 추가
      const equipButtons = document.querySelectorAll('.equip-btn');
      equipButtons.forEach(button => {
        button.addEventListener('click', function() {
          const item = this.getAttribute('data-item');
          equipItem(item);
        });
      });
      
      // 해제 버튼 이벤트 리스너 추가
      const unequipButtons = document.querySelectorAll('.unequip-btn');
      unequipButtons.forEach(button => {
        button.addEventListener('click', function() {
          const item = this.getAttribute('data-item');
          unequipItem(item);
        });
      });
      
      // 판매 버튼 이벤트 리스너 추가
      const sellButtons = document.querySelectorAll('.sell-btn');
      sellButtons.forEach(button => {
        button.addEventListener('click', function() {
          const item = this.getAttribute('data-item');
          sellItem(item);
        });
      });
    }
    
    // 아이템 장착 함수
    function equipItem(item) {
      if (!isConnected) {
        alert('서버에 연결되어 있지 않습니다.');
        return;
      }
      
      socket.send(JSON.stringify({
        type: 'equipItem',
        item: item
      }));
    }
    
    // 아이템 해제 함수
    function unequipItem(item) {
      if (!isConnected) {
        alert('서버에 연결되어 있지 않습니다.');
        return;
      }
      
      socket.send(JSON.stringify({
        type: 'unequipItem',
        item: item
      }));
    }
    
    // 아이템 판매 함수
    function sellItem(item) {
      if (!isConnected) {
        alert('서버에 연결되어 있지 않습니다.');
        return;
      }
      
      // 낚시대나 악세서리는 판매할 수 없음
      if (rodNames.includes(item) || accessoryNames.includes(item)) {
        alert('낚시대와 악세서리는 판매할 수 없습니다.');
        return;
      }
      
      const quantity = prompt(`${item}을(를) 몇 개 판매하시겠습니까?`, '1');
      if (quantity === null) return;
      
      const amount = parseInt(quantity);
      if (isNaN(amount) || amount <= 0) {
        alert('올바른 수량을 입력해주세요.');
        return;
      }
      
      socket.send(JSON.stringify({
        type: 'sellItem',
        item: item,
        quantity: amount
      }));
    }

    function updateStoreList() {
      console.log("updateStoreList 호출됨");
      const storeList = document.getElementById('storeList');
      if (!storeList) {
        console.error("storeList 요소를 찾을 수 없습니다");
        return;
      }
      
      storeList.innerHTML = '';
      
      // 낚시대 추가
      const rodSection = document.createElement('div');
      rodSection.className = 'store-section';
      rodSection.innerHTML = '<h3>🎣 낚시대 (구매 시 낚시 스킬 레벨이 자동으로 해당 레벨로 상승)</h3>';
      storeList.appendChild(rodSection);
      
      // 낚시대 상품 생성 (레벨에 따른 비용 설정)
      for (const [level, name] of Object.entries(rodNames)) {
        if (level == 0) continue; // 맨손은 상점에서 판매하지 않음
        
        const rodLevel = parseInt(level);
        const rodPrice = rodLevel * rodLevel * 5000;
        
        const rodItem = document.createElement('div');
        rodItem.className = 'store-item';
        rodItem.innerHTML = `
          <span>${name} (레벨 ${rodLevel})</span>
          <div class="item-details">
            <span class="price">${formatPrice(rodPrice)}원</span>
            <button class="buy-btn" data-item="${name}" data-price="${rodPrice}">구매</button>
          </div>
        `;
        rodSection.appendChild(rodItem);
      }
      
      // 악세사리 추가
      const accessorySection = document.createElement('div');
      accessorySection.className = 'store-section';
      accessorySection.innerHTML = '<h3>💍 악세사리 (쿨다운 감소 및 판매 보너스)</h3>';
      storeList.appendChild(accessorySection);
      
      // 악세사리 상품 생성 (레벨에 따른 비용 설정)
      for (const [level, name] of Object.entries(accessoryNames)) {
        if (level == 0) continue; // '없음'은 상점에서 판매하지 않음
        
        const accessoryLevel = parseInt(level);
        const accessoryPrice = accessoryLevel * accessoryLevel * 8000;
        
        // 악세사리 효과 설명
        let effectDesc = '';
        if (name === "오래된반지") {
          effectDesc = "낚시 쿨다운 -15초, 판매 보너스 +5%";
        } else if (name === "은목걸이") {
          effectDesc = "낚시 쿨다운 -30초, 판매 보너스 +10%";
        } else if (name === "금귀걸이") {
          effectDesc = "낚시 쿨다운 -45초, 판매 보너스 +15%";
        } else if (name === "마법의펜던트") {
          effectDesc = "낚시 쿨다운 -60초, 판매 보너스 +20%";
        } else if (name === "에메랄드브로치") {
          effectDesc = "낚시 쿨다운 -75초, 판매 보너스 +25%";
        } else if (name === "토파즈이어링") {
          effectDesc = "낚시 쿨다운 -90초, 판매 보너스 +30%";
        } else if (name === "자수정팔찌") {
          effectDesc = "낚시 쿨다운 -105초, 판매 보너스 +35%";
        } else if (name === "백금티아라") {
          effectDesc = "낚시 쿨다운 -120초, 판매 보너스 +40%";
        } else if (name === "만드라고라허브") {
          effectDesc = "낚시 쿨다운 -135초, 판매 보너스 +45%";
        } else if (name === "에테르나무묘목") {
          effectDesc = "낚시 쿨다운 -150초, 판매 보너스 +50%";
        } else if (name === "몽마의조각상") {
          effectDesc = "낚시 쿨다운 -165초, 판매 보너스 +55%";
        } else if (name === "마카롱훈장") {
          effectDesc = "낚시 쿨다운 -180초, 판매 보너스 +60%";
        } else if (name === "빛나는마력순환체") {
          effectDesc = "낚시 쿨다운 -210초, 판매 보너스 +80%";
        }
        
        const accessoryItem = document.createElement('div');
        accessoryItem.className = 'store-item';
        accessoryItem.innerHTML = `
          <span>${name}</span>
          <div class="item-effect">${effectDesc}</div>
          <div class="item-details">
            <span class="price">${formatPrice(accessoryPrice)}원</span>
            <button class="buy-btn" data-item="${name}" data-price="${accessoryPrice}">구매</button>
          </div>
        `;
        accessorySection.appendChild(accessoryItem);
      }
    }

    // 페이지 로드 시 초기화
    document.addEventListener('DOMContentLoaded', function() {
      console.log("페이지 로드됨");
      
      // 가격 포맷 함수 추가
      window.formatPrice = function(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      };
      
      // 상점 리스트 초기화
      if (document.getElementById('storeList')) {
        console.log("상점 리스트 초기화");
        updateStoreList();
      
        // 상점에서 구매 버튼 클릭 이벤트 위임
        document.getElementById('storeList').addEventListener('click', function(e) {
          if (e.target.classList.contains('buy-btn')) {
            const item = e.target.getAttribute('data-item');
            const price = parseInt(e.target.getAttribute('data-price'));
            
            if (!isConnected) {
              alert('서버에 연결되어 있지 않습니다. 먼저 채팅방에 입장하세요.');
              return;
            }
            
            socket.send(JSON.stringify({ 
              type: 'buy', 
              item: '구매 ' + item,
              price: price 
            }));
          }
        });
      } else {
        console.error("storeList 요소를 찾을 수 없습니다");
      }
    });
  </script>
</body>
</html>
